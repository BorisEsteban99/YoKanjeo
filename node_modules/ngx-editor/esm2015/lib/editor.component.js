import { Component, ViewChild, forwardRef, ViewEncapsulation, Output, EventEmitter, Input, } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { EditorState, Plugin, PluginKey } from 'prosemirror-state';
import { EditorView } from 'prosemirror-view';
import { NgxEditorService } from './editor.service';
import { SharedService } from './services/shared/shared.service';
import { editable as editablePlugin, placeholder as placeholderPlugin } from 'ngx-editor/plugins';
import { parseValue, toHTML } from './parsers';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './editor.service';
import * as ɵngcc2 from './services/shared/shared.service';
import * as ɵngcc3 from '@angular/common';
import * as ɵngcc4 from './components/bubble/bubble.component';
import * as ɵngcc5 from './modules/menu/menu.component';

const _c0 = ["ngxEditor"];
function NgxEditorComponent_ngx_menu_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "ngx-menu", 3);
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("toolbar", ctx_r1.toolbar)("editorView", ctx_r1.view)("disabled", !ctx_r1.editable);
} }
export class NgxEditorComponent {
    constructor(ngxEditorService, sharedService) {
        this.sharedService = sharedService;
        this.editorInitialized = false;
        this.placeholder = 'Type here...';
        this.editable = true;
        this.init = new EventEmitter();
        this.focusOut = new EventEmitter();
        this.focusIn = new EventEmitter();
        this.config = ngxEditorService.config;
    }
    get toolbar() {
        var _a;
        return (_a = this.config.menu) === null || _a === void 0 ? void 0 : _a.toolbar;
    }
    writeValue(value) {
        if (!this.editorInitialized) {
            return;
        }
        if (!this.outputFormat && typeof value === 'string') {
            this.outputFormat = 'html';
        }
        this.updateContent(value);
    }
    registerOnChange(fn) {
        this.onChange = fn;
    }
    registerOnTouched(fn) {
        this.onTouched = fn;
    }
    updateContent(value) {
        try {
            const { state } = this.view;
            const { tr, doc } = state;
            const newDoc = parseValue(value, this.config.schema);
            tr.replaceWith(0, state.doc.content.size, newDoc)
                .setMeta('PREVENT_ONCHANGE', true);
            // don't emit if both content is same
            if (doc !== null && doc.eq(tr.doc)) {
                return;
            }
            if (!tr.docChanged) {
                return;
            }
            this.view.dispatch(tr);
        }
        catch (err) {
            console.error('Unable to update document.', err);
        }
    }
    handleTransactions(tr) {
        const { state } = this.view.state.applyTransaction(tr);
        this.view.updateState(state);
        if (!tr.docChanged || !this.onChange || tr.getMeta('PREVENT_ONCHANGE')) {
            return;
        }
        const json = state.doc.toJSON();
        if (this.outputFormat === 'html') {
            const html = toHTML(json, this.config.schema);
            this.onChange(html);
            return;
        }
        this.onChange(json);
    }
    createUpdateWatcherPlugin() {
        const plugin = new Plugin({
            key: new PluginKey('ngx-update-watcher'),
            view: () => {
                return {
                    update: (view) => this.sharedService.plugin.update.next(view),
                    destroy: () => this.sharedService.plugin.destroy.next()
                };
            }
        });
        return plugin;
    }
    filterBuiltIns(plugin) {
        const pluginKey = plugin.key;
        if (/^(editable|placeholder)\$/.test(pluginKey)) {
            return false;
        }
        return true;
    }
    createEditor() {
        const { schema, plugins, nodeViews } = this.config;
        this.view = new EditorView(this.ngxEditor.nativeElement, {
            state: EditorState.create({
                doc: null,
                schema,
                plugins: [
                    ...plugins.filter((plugin) => this.filterBuiltIns(plugin)),
                    this.createUpdateWatcherPlugin(),
                    placeholderPlugin(this.placeholder),
                    editablePlugin(this.editable)
                ]
            }),
            nodeViews,
            dispatchTransaction: this.handleTransactions.bind(this),
            handleDOMEvents: {
                focus: () => {
                    this.focusIn.emit();
                    return false;
                },
                blur: () => {
                    this.onTouched();
                    this.focusOut.emit();
                    return false;
                }
            },
            attributes: {
                class: 'NgxEditor__Content'
            },
        });
        this.editorInitialized = true;
        this.sharedService.view = this.view;
        this.sharedService.setCustomMenuRef(this.customMenuRef);
        this.init.emit(this.view);
    }
    setPlaceholder(newPlaceholder) {
        const { dispatch, state: { tr } } = this.view;
        const placeholder = newPlaceholder !== null && newPlaceholder !== void 0 ? newPlaceholder : this.placeholder;
        dispatch(tr.setMeta('UPDATE_PLACEHOLDER', placeholder));
    }
    updateEditable(edit) {
        const { dispatch, state: { tr } } = this.view;
        dispatch(tr.setMeta('UPDATE_EDITABLE', edit));
    }
    ngOnInit() {
        this.createEditor();
        this.setPlaceholder();
    }
    ngOnChanges(changes) {
        if ((changes === null || changes === void 0 ? void 0 : changes.placeholder) && !changes.placeholder.isFirstChange()) {
            this.setPlaceholder(changes.placeholder.currentValue);
        }
        if ((changes === null || changes === void 0 ? void 0 : changes.editable) && !changes.editable.isFirstChange()) {
            this.updateEditable(changes.editable.currentValue);
        }
    }
    ngOnDestroy() {
        this.view.destroy();
    }
}
NgxEditorComponent.ɵfac = function NgxEditorComponent_Factory(t) { return new (t || NgxEditorComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.NgxEditorService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.SharedService)); };
NgxEditorComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: NgxEditorComponent, selectors: [["ngx-editor"]], viewQuery: function NgxEditorComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵstaticViewQuery(_c0, true);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.ngxEditor = _t.first);
    } }, inputs: { placeholder: "placeholder", editable: "editable", outputFormat: "outputFormat", customMenuRef: "customMenuRef" }, outputs: { init: "init", focusOut: "focusOut", focusIn: "focusIn" }, features: [ɵngcc0.ɵɵProvidersFeature([{
                provide: NG_VALUE_ACCESSOR,
                useExisting: forwardRef(() => NgxEditorComponent),
                multi: true
            }]), ɵngcc0.ɵɵNgOnChangesFeature], decls: 4, vars: 1, consts: [[1, "NgxEditor"], ["ngxEditor", ""], [3, "toolbar", "editorView", "disabled", 4, "ngIf"], [3, "toolbar", "editorView", "disabled"]], template: function NgxEditorComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "div", 0, 1);
        ɵngcc0.ɵɵtemplate(2, NgxEditorComponent_ngx_menu_2_Template, 1, 3, "ngx-menu", 2);
        ɵngcc0.ɵɵelement(3, "ngx-bubble");
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngIf", ctx.toolbar);
    } }, directives: [ɵngcc3.NgIf, ɵngcc4.BubbleComponent, ɵngcc5.MenuComponent], styles: [".NgxEditor{background:#fff;background-clip:padding-box;border:2px solid rgba(0,0,0,.2);border-radius:4px;color:#000;overflow:hidden;position:relative}.NgxEditor--Disabled{opacity:.5;pointer-events:none}.NgxEditor__Placeholder{-moz-user-select:none;-ms-user-select:none;-webkit-user-select:none;color:#6c757d;cursor:text;opacity:1;position:absolute;user-select:none}.NgxEditor__Content{padding:.5rem;white-space:pre-wrap}.NgxEditor__Content p{margin:0 0 .7rem}.NgxEditor__Content blockquote{border-left:3px solid #ddd;margin-left:0;margin-right:0;padding-left:1rem}.NgxEditor__Content--Disabled{-moz-user-select:none;-ms-user-select:none;-webkit-user-select:none;pointer-events:none;user-select:none}.NgxEditor__ImageWrapper{display:inline-block;line-height:0;padding:2px;position:relative}.NgxEditor__ImageWrapper.NgxEditor__Resizer--Active{border:1px solid #1a73e8;padding:1px}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle{display:none;height:100%;position:absolute;width:100%}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--BL,.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--BR,.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--TL,.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--TR{background-color:#1a73e8;border:1px solid #fff;height:7px;position:absolute;width:7px}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--BR{bottom:-5px;cursor:se-resize;right:-5px}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--TR{cursor:ne-resize;right:-5px;top:-5px}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--TL{cursor:nw-resize;left:-5px;top:-5px}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--BL{bottom:-5px;cursor:sw-resize;left:-5px}.ProseMirror{outline:none}.NgxEditor__HelpText{font-size:80%}.NgxEditor__HelpText.NgxEditor__HelpText--Error{color:red}"], encapsulation: 2 });
NgxEditorComponent.ctorParameters = () => [
    { type: NgxEditorService },
    { type: SharedService }
];
NgxEditorComponent.propDecorators = {
    ngxEditor: [{ type: ViewChild, args: ['ngxEditor', { static: true },] }],
    outputFormat: [{ type: Input }],
    customMenuRef: [{ type: Input }],
    placeholder: [{ type: Input }],
    editable: [{ type: Input }],
    init: [{ type: Output }],
    focusOut: [{ type: Output }],
    focusIn: [{ type: Output }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(NgxEditorComponent, [{
        type: Component,
        args: [{
                selector: 'ngx-editor',
                template: "<div class=\"NgxEditor\" #ngxEditor>\n  <ngx-menu \n    [toolbar]=\"toolbar\" \n    [editorView]=\"view\"\n    *ngIf=\"toolbar\"\n    [disabled]=\"!editable\"\n  >\n  </ngx-menu>\n  <ngx-bubble></ngx-bubble>\n</div>\n",
                providers: [{
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef(() => NgxEditorComponent),
                        multi: true
                    }],
                encapsulation: ViewEncapsulation.None,
                styles: [".NgxEditor{background:#fff;background-clip:padding-box;border:2px solid rgba(0,0,0,.2);border-radius:4px;color:#000;overflow:hidden;position:relative}.NgxEditor--Disabled{opacity:.5;pointer-events:none}.NgxEditor__Placeholder{-moz-user-select:none;-ms-user-select:none;-webkit-user-select:none;color:#6c757d;cursor:text;opacity:1;position:absolute;user-select:none}.NgxEditor__Content{padding:.5rem;white-space:pre-wrap}.NgxEditor__Content p{margin:0 0 .7rem}.NgxEditor__Content blockquote{border-left:3px solid #ddd;margin-left:0;margin-right:0;padding-left:1rem}.NgxEditor__Content--Disabled{-moz-user-select:none;-ms-user-select:none;-webkit-user-select:none;pointer-events:none;user-select:none}.NgxEditor__ImageWrapper{display:inline-block;line-height:0;padding:2px;position:relative}.NgxEditor__ImageWrapper.NgxEditor__Resizer--Active{border:1px solid #1a73e8;padding:1px}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle{display:none;height:100%;position:absolute;width:100%}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--BL,.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--BR,.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--TL,.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--TR{background-color:#1a73e8;border:1px solid #fff;height:7px;position:absolute;width:7px}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--BR{bottom:-5px;cursor:se-resize;right:-5px}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--TR{cursor:ne-resize;right:-5px;top:-5px}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--TL{cursor:nw-resize;left:-5px;top:-5px}.NgxEditor__ImageWrapper .NgxEditor__ResizeHandle .NgxEditor__ResizeHandle--BL{bottom:-5px;cursor:sw-resize;left:-5px}.ProseMirror{outline:none}.NgxEditor__HelpText{font-size:80%}.NgxEditor__HelpText.NgxEditor__HelpText--Error{color:red}"]
            }]
    }], function () { return [{ type: ɵngcc1.NgxEditorService }, { type: ɵngcc2.SharedService }]; }, { placeholder: [{
            type: Input
        }], editable: [{
            type: Input
        }], init: [{
            type: Output
        }], focusOut: [{
            type: Output
        }], focusIn: [{
            type: Output
        }], outputFormat: [{
            type: Input
        }], ngxEditor: [{
            type: ViewChild,
            args: ['ngxEditor', { static: true }]
        }], customMenuRef: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9lZGl0b3IuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQUUsU0FBUyxFQUNwQixVQUFVLEVBQWEsaUJBQWlCLEVBQ3hDLE1BQU0sRUFBRSxZQUFZLEVBQUUsS0FBSyxHQUU1QixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsaUJBQWlCLEVBQXdCLE1BQU0sZ0JBQWdCLENBQUM7QUFFekUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFlLE1BQU0sbUJBQW1CLENBQUM7QUFDaEYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRTlDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBMEIsTUFBTSxrQkFBa0IsQ0FBQztBQUM1RSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFFakUsT0FBTyxFQUFFLFFBQVEsSUFBSSxjQUFjLEVBQUUsV0FBVyxJQUFJLGlCQUFpQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbEcsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7Ozs7Ozs7Ozs7Ozs7OztBQWMvQyxNQUFNLE9BQU8sa0JBQWtCO0FBQUcsSUFrQmhDLFlBQ0UsZ0JBQWtDLEVBQzFCLGFBQTRCO0FBQ3RDLFFBRFUsa0JBQWEsR0FBYixhQUFhLENBQWU7QUFBQyxRQVovQixzQkFBaUIsR0FBRyxLQUFLLENBQUM7QUFDcEMsUUFHVyxnQkFBVyxHQUFHLGNBQWMsQ0FBQztBQUN4QyxRQUFXLGFBQVEsR0FBRyxJQUFJLENBQUM7QUFDM0IsUUFBWSxTQUFJLEdBQUcsSUFBSSxZQUFZLEVBQWMsQ0FBQztBQUNsRCxRQUFZLGFBQVEsR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO0FBQ2hELFFBQVksWUFBTyxHQUFHLElBQUksWUFB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Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LCBWaWV3Q2hpbGQsIEVsZW1lbnRSZWYsXG4gIGZvcndhcmRSZWYsIE9uRGVzdHJveSwgVmlld0VuY2Fwc3VsYXRpb24sIE9uSW5pdCxcbiAgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIElucHV0LCBUZW1wbGF0ZVJlZixcbiAgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5HX1ZBTFVFX0FDQ0VTU09SLCBDb250cm9sVmFsdWVBY2Nlc3NvciB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcblxuaW1wb3J0IHsgRWRpdG9yU3RhdGUsIFBsdWdpbiwgUGx1Z2luS2V5LCBUcmFuc2FjdGlvbiB9IGZyb20gJ3Byb3NlbWlycm9yLXN0YXRlJztcbmltcG9ydCB7IEVkaXRvclZpZXcgfSBmcm9tICdwcm9zZW1pcnJvci12aWV3JztcblxuaW1wb3J0IHsgTmd4RWRpdG9yU2VydmljZSwgTmd4RWRpdG9yU2VydmljZUNvbmZpZyB9IGZyb20gJy4vZWRpdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgU2hhcmVkU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvc2hhcmVkL3NoYXJlZC5zZXJ2aWNlJztcbmltcG9ydCB7IFRvb2xiYXIgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IGVkaXRhYmxlIGFzIGVkaXRhYmxlUGx1Z2luLCBwbGFjZWhvbGRlciBhcyBwbGFjZWhvbGRlclBsdWdpbiB9IGZyb20gJ25neC1lZGl0b3IvcGx1Z2lucyc7XG5pbXBvcnQgeyBwYXJzZVZhbHVlLCB0b0hUTUwgfSBmcm9tICcuL3BhcnNlcnMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3gtZWRpdG9yJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2VkaXRvci5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2VkaXRvci5jb21wb25lbnQuc2NzcyddLFxuICBwcm92aWRlcnM6IFt7XG4gICAgcHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsXG4gICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gTmd4RWRpdG9yQ29tcG9uZW50KSxcbiAgICBtdWx0aTogdHJ1ZVxuICB9XSxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcblxuZXhwb3J0IGNsYXNzIE5neEVkaXRvckNvbXBvbmVudCBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBPbkluaXQsIE9uRGVzdHJveSwgT25DaGFuZ2VzIHtcbiAgQFZpZXdDaGlsZCgnbmd4RWRpdG9yJywgeyBzdGF0aWM6IHRydWUgfSkgbmd4RWRpdG9yOiBFbGVtZW50UmVmO1xuXG4gIHZpZXc6IEVkaXRvclZpZXc7XG4gIHByaXZhdGUgb25DaGFuZ2U6ICh2YWx1ZTogUmVjb3JkPHN0cmluZywgYW55PiB8IHN0cmluZykgPT4gdm9pZDtcbiAgcHJpdmF0ZSBvblRvdWNoZWQ6ICgpID0+IHZvaWQ7XG5cbiAgcHJpdmF0ZSBjb25maWc6IE5neEVkaXRvclNlcnZpY2VDb25maWc7XG4gIHByaXZhdGUgZWRpdG9ySW5pdGlhbGl6ZWQgPSBmYWxzZTtcblxuICBASW5wdXQoKSBvdXRwdXRGb3JtYXQ6ICdkb2MnIHwgJ2h0bWwnO1xuICBASW5wdXQoKSBjdXN0b21NZW51UmVmOiBUZW1wbGF0ZVJlZjxhbnk+O1xuICBASW5wdXQoKSBwbGFjZWhvbGRlciA9ICdUeXBlIGhlcmUuLi4nO1xuICBASW5wdXQoKSBlZGl0YWJsZSA9IHRydWU7XG4gIEBPdXRwdXQoKSBpbml0ID0gbmV3IEV2ZW50RW1pdHRlcjxFZGl0b3JWaWV3PigpO1xuICBAT3V0cHV0KCkgZm9jdXNPdXQgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIEBPdXRwdXQoKSBmb2N1c0luID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIG5neEVkaXRvclNlcnZpY2U6IE5neEVkaXRvclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBzaGFyZWRTZXJ2aWNlOiBTaGFyZWRTZXJ2aWNlLFxuICApIHtcbiAgICB0aGlzLmNvbmZpZyA9IG5neEVkaXRvclNlcnZpY2UuY29uZmlnO1xuICB9XG5cbiAgZ2V0IHRvb2xiYXIoKTogVG9vbGJhciB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLm1lbnU/LnRvb2xiYXI7XG4gIH1cblxuICB3cml0ZVZhbHVlKHZhbHVlOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgc3RyaW5nIHwgbnVsbCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5lZGl0b3JJbml0aWFsaXplZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5vdXRwdXRGb3JtYXQgJiYgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgdGhpcy5vdXRwdXRGb3JtYXQgPSAnaHRtbCc7XG4gICAgfVxuXG4gICAgdGhpcy51cGRhdGVDb250ZW50KHZhbHVlKTtcbiAgfVxuXG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46IGFueSk6IHZvaWQge1xuICAgIHRoaXMub25DaGFuZ2UgPSBmbjtcbiAgfVxuXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLm9uVG91Y2hlZCA9IGZuO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVDb250ZW50KHZhbHVlOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgc3RyaW5nKTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgc3RhdGUgfSA9IHRoaXMudmlldztcbiAgICAgIGNvbnN0IHsgdHIsIGRvYyB9ID0gc3RhdGU7XG5cbiAgICAgIGNvbnN0IG5ld0RvYyA9IHBhcnNlVmFsdWUodmFsdWUsIHRoaXMuY29uZmlnLnNjaGVtYSk7XG4gICAgICB0ci5yZXBsYWNlV2l0aCgwLCBzdGF0ZS5kb2MuY29udGVudC5zaXplLCBuZXdEb2MpXG4gICAgICAgIC5zZXRNZXRhKCdQUkVWRU5UX09OQ0hBTkdFJywgdHJ1ZSk7XG5cbiAgICAgIC8vIGRvbid0IGVtaXQgaWYgYm90aCBjb250ZW50IGlzIHNhbWVcbiAgICAgIGlmIChkb2MgIT09IG51bGwgJiYgZG9jLmVxKHRyLmRvYykpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXRyLmRvY0NoYW5nZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnZpZXcuZGlzcGF0Y2godHIpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcignVW5hYmxlIHRvIHVwZGF0ZSBkb2N1bWVudC4nLCBlcnIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlVHJhbnNhY3Rpb25zKHRyOiBUcmFuc2FjdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IHsgc3RhdGUgfSA9IHRoaXMudmlldy5zdGF0ZS5hcHBseVRyYW5zYWN0aW9uKHRyKTtcbiAgICB0aGlzLnZpZXcudXBkYXRlU3RhdGUoc3RhdGUpO1xuXG4gICAgaWYgKCF0ci5kb2NDaGFuZ2VkIHx8ICF0aGlzLm9uQ2hhbmdlIHx8IHRyLmdldE1ldGEoJ1BSRVZFTlRfT05DSEFOR0UnKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGpzb24gPSBzdGF0ZS5kb2MudG9KU09OKCk7XG5cbiAgICBpZiAodGhpcy5vdXRwdXRGb3JtYXQgPT09ICdodG1sJykge1xuICAgICAgY29uc3QgaHRtbCA9IHRvSFRNTChqc29uLCB0aGlzLmNvbmZpZy5zY2hlbWEpO1xuICAgICAgdGhpcy5vbkNoYW5nZShodG1sKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLm9uQ2hhbmdlKGpzb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVVcGRhdGVXYXRjaGVyUGx1Z2luKCk6IFBsdWdpbiB7XG4gICAgY29uc3QgcGx1Z2luID0gbmV3IFBsdWdpbih7XG4gICAgICBrZXk6IG5ldyBQbHVnaW5LZXkoJ25neC11cGRhdGUtd2F0Y2hlcicpLFxuICAgICAgdmlldzogKCkgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHVwZGF0ZTogKHZpZXc6IEVkaXRvclZpZXcpID0+IHRoaXMuc2hhcmVkU2VydmljZS5wbHVnaW4udXBkYXRlLm5leHQodmlldyksXG4gICAgICAgICAgZGVzdHJveTogKCkgPT4gdGhpcy5zaGFyZWRTZXJ2aWNlLnBsdWdpbi5kZXN0cm95Lm5leHQoKVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHBsdWdpbjtcbiAgfVxuXG4gIHByaXZhdGUgZmlsdGVyQnVpbHRJbnMocGx1Z2luOiBQbHVnaW4pOiBib29sZWFuIHtcbiAgICBjb25zdCBwbHVnaW5LZXk6IHN0cmluZyA9IChwbHVnaW4gYXMgYW55KS5rZXk7XG4gICAgaWYgKC9eKGVkaXRhYmxlfHBsYWNlaG9sZGVyKVxcJC8udGVzdChwbHVnaW5LZXkpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUVkaXRvcigpOiB2b2lkIHtcbiAgICBjb25zdCB7IHNjaGVtYSwgcGx1Z2lucywgbm9kZVZpZXdzIH0gPSB0aGlzLmNvbmZpZztcblxuICAgIHRoaXMudmlldyA9IG5ldyBFZGl0b3JWaWV3KHRoaXMubmd4RWRpdG9yLm5hdGl2ZUVsZW1lbnQsIHtcbiAgICAgIHN0YXRlOiBFZGl0b3JTdGF0ZS5jcmVhdGUoe1xuICAgICAgICBkb2M6IG51bGwsXG4gICAgICAgIHNjaGVtYSxcbiAgICAgICAgcGx1Z2luczogW1xuICAgICAgICAgIC4uLnBsdWdpbnMuZmlsdGVyKChwbHVnaW4pID0+IHRoaXMuZmlsdGVyQnVpbHRJbnMocGx1Z2luKSksXG4gICAgICAgICAgdGhpcy5jcmVhdGVVcGRhdGVXYXRjaGVyUGx1Z2luKCksXG4gICAgICAgICAgcGxhY2Vob2xkZXJQbHVnaW4odGhpcy5wbGFjZWhvbGRlciksXG4gICAgICAgICAgZWRpdGFibGVQbHVnaW4odGhpcy5lZGl0YWJsZSlcbiAgICAgICAgXVxuICAgICAgfSksXG4gICAgICBub2RlVmlld3MsXG4gICAgICBkaXNwYXRjaFRyYW5zYWN0aW9uOiB0aGlzLmhhbmRsZVRyYW5zYWN0aW9ucy5iaW5kKHRoaXMpLFxuICAgICAgaGFuZGxlRE9NRXZlbnRzOiB7XG4gICAgICAgIGZvY3VzOiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5mb2N1c0luLmVtaXQoKTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0sXG4gICAgICAgIGJsdXI6ICgpID0+IHtcbiAgICAgICAgICB0aGlzLm9uVG91Y2hlZCgpO1xuICAgICAgICAgIHRoaXMuZm9jdXNPdXQuZW1pdCgpO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGF0dHJpYnV0ZXM6IHtcbiAgICAgICAgY2xhc3M6ICdOZ3hFZGl0b3JfX0NvbnRlbnQnXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy5lZGl0b3JJbml0aWFsaXplZCA9IHRydWU7XG4gICAgdGhpcy5zaGFyZWRTZXJ2aWNlLnZpZXcgPSB0aGlzLnZpZXc7XG4gICAgdGhpcy5zaGFyZWRTZXJ2aWNlLnNldEN1c3RvbU1lbnVSZWYodGhpcy5jdXN0b21NZW51UmVmKTtcbiAgICB0aGlzLmluaXQuZW1pdCh0aGlzLnZpZXcpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRQbGFjZWhvbGRlcihuZXdQbGFjZWhvbGRlcj86IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHsgZGlzcGF0Y2gsIHN0YXRlOiB7IHRyIH0gfSA9IHRoaXMudmlldztcbiAgICBjb25zdCBwbGFjZWhvbGRlciA9IG5ld1BsYWNlaG9sZGVyID8/IHRoaXMucGxhY2Vob2xkZXI7XG4gICAgZGlzcGF0Y2godHIuc2V0TWV0YSgnVVBEQVRFX1BMQUNFSE9MREVSJywgcGxhY2Vob2xkZXIpKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlRWRpdGFibGUoZWRpdDogYm9vbGVhbik6IHZvaWQge1xuICAgIGNvbnN0IHsgZGlzcGF0Y2gsIHN0YXRlOiB7IHRyIH0gfSA9IHRoaXMudmlldztcbiAgICBkaXNwYXRjaCh0ci5zZXRNZXRhKCdVUERBVEVfRURJVEFCTEUnLCBlZGl0KSk7XG4gIH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmNyZWF0ZUVkaXRvcigpO1xuICAgIHRoaXMuc2V0UGxhY2Vob2xkZXIoKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlcz8ucGxhY2Vob2xkZXIgJiYgIWNoYW5nZXMucGxhY2Vob2xkZXIuaXNGaXJzdENoYW5nZSgpKSB7XG4gICAgICB0aGlzLnNldFBsYWNlaG9sZGVyKGNoYW5nZXMucGxhY2Vob2xkZXIuY3VycmVudFZhbHVlKTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcz8uZWRpdGFibGUgJiYgIWNoYW5nZXMuZWRpdGFibGUuaXNGaXJzdENoYW5nZSgpKSB7XG4gICAgICB0aGlzLnVwZGF0ZUVkaXRhYmxlKGNoYW5nZXMuZWRpdGFibGUuY3VycmVudFZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnZpZXcuZGVzdHJveSgpO1xuICB9XG59XG4iXX0=