import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { emojis } from './data/emojis';
import * as i0 from "@angular/core";
import * as ɵngcc0 from '@angular/core';
const COLONS_REGEX = /^(?:\:([^\:]+)\:)(?:\:skin-tone-(\d)\:)?$/;
const SKINS = ['1F3FA', '1F3FB', '1F3FC', '1F3FD', '1F3FE', '1F3FF'];
export const DEFAULT_BACKGROUNDFN = (set, sheetSize) => `https://unpkg.com/emoji-datasource-${set}@5.0.1/img/${set}/sheets-256/${sheetSize}.png`;
let EmojiService = class EmojiService {
    constructor() {
        this.uncompressed = false;
        this.names = {};
        this.emojis = [];
        if (!this.uncompressed) {
            this.uncompress(emojis);
            this.uncompressed = true;
        }
    }
    uncompress(list) {
        this.emojis = list.map(emoji => {
            const data = Object.assign({}, emoji);
            if (!data.shortNames) {
                data.shortNames = [];
            }
            data.shortNames.unshift(data.shortName);
            data.id = data.shortName;
            data.native = this.unifiedToNative(data.unified);
            if (!data.skinVariations) {
                data.skinVariations = [];
            }
            if (!data.keywords) {
                data.keywords = [];
            }
            if (!data.emoticons) {
                data.emoticons = [];
            }
            if (!data.hidden) {
                data.hidden = [];
            }
            if (!data.text) {
                data.text = '';
            }
            if (data.obsoletes) {
                // get keywords from emoji that it obsoletes since that is shared
                const f = list.find(x => x.unified === data.obsoletes);
                if (f) {
                    if (f.keywords) {
                        data.keywords = [...data.keywords, ...f.keywords, f.shortName];
                    }
                    else {
                        data.keywords = [...data.keywords, f.shortName];
                    }
                }
            }
            this.names[data.unified] = data;
            for (const n of data.shortNames) {
                this.names[n] = data;
            }
            return data;
        });
    }
    getData(emoji, skin, set) {
        let emojiData;
        if (typeof emoji === 'string') {
            const matches = emoji.match(COLONS_REGEX);
            if (matches) {
                emoji = matches[1];
                if (matches[2]) {
                    skin = parseInt(matches[2], 10);
                }
            }
            if (this.names.hasOwnProperty(emoji)) {
                emojiData = this.names[emoji];
            }
            else {
                return null;
            }
        }
        else if (emoji.id) {
            emojiData = this.names[emoji.id];
        }
        else if (emoji.unified) {
            emojiData = this.names[emoji.unified.toUpperCase()];
        }
        if (!emojiData) {
            emojiData = emoji;
            emojiData.custom = true;
        }
        const hasSkinVariations = emojiData.skinVariations && emojiData.skinVariations.length;
        if (hasSkinVariations && skin && skin > 1 && set) {
            emojiData = Object.assign({}, emojiData);
            const skinKey = SKINS[skin - 1];
            const variationData = emojiData.skinVariations.find((n) => n.unified.includes(skinKey));
            if (!variationData.hidden || !variationData.hidden.includes(set)) {
                emojiData.skinTone = skin;
                emojiData = Object.assign(Object.assign({}, emojiData), variationData);
            }
            emojiData.native = this.unifiedToNative(emojiData.unified);
        }
        emojiData.set = set || '';
        return emojiData;
    }
    unifiedToNative(unified) {
        const codePoints = unified.split('-').map(u => parseInt(`0x${u}`, 16));
        return String.fromCodePoint(...codePoints);
    }
    emojiSpriteStyles(sheet, set = 'apple', size = 24, sheetSize = 64, sheetRows = 57, backgroundImageFn = DEFAULT_BACKGROUNDFN, sheetColumns = 57) {
        return {
            width: `${size}px`,
            height: `${size}px`,
            display: 'inline-block',
            'background-image': `url(${backgroundImageFn(set, sheetSize)})`,
            'background-size': `${100 * sheetColumns}% ${100 * sheetRows}%`,
            'background-position': this.getSpritePosition(sheet, sheetColumns),
        };
    }
    getSpritePosition(sheet, sheetColumns) {
        const [sheetX, sheetY] = sheet;
        const multiply = 100 / (sheetColumns - 1);
        return `${multiply * sheetX}% ${multiply * sheetY}%`;
    }
    sanitize(emoji) {
        if (emoji === null) {
            return null;
        }
        const id = emoji.id || emoji.shortNames[0];
        let colons = `:${id}:`;
        if (emoji.skinTone) {
            colons += `:skin-tone-${emoji.skinTone}:`;
        }
        emoji.colons = colons;
        return Object.assign({}, emoji);
    }
    getSanitizedData(emoji, skin, set) {
        return this.sanitize(this.getData(emoji, skin, set));
    }
};
EmojiService.ɵfac = function EmojiService_Factory(t) { return new (t || EmojiService)(); };
EmojiService.ɵprov = i0.ɵɵdefineInjectable({ factory: function EmojiService_Factory() { return new EmojiService(); }, token: EmojiService, providedIn: "root" });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(EmojiService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return []; }, null); })();
export { EmojiService };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1vamkuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiQGN0cmwvbmd4LWVtb2ppLW1hcnQvbmd4LWVtb2ppL2Vtb2ppLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFPM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2Qzs7QUFFQSxNQUFNLFlBQVksR0FBRywyQ0FBMkMsQ0FBQztBQUNqRSxNQUFNLEtBQUssR0FBRyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDckUsTUFBTSxDQUFDLE1BQU0sb0JBQW9CLEdBQUcsQ0FDbEMsR0FBVyxFQUNYLFNBQWlCLEVBQ2pCLEVBQUUsQ0FBQyxzQ0FBc0MsR0FBRyxjQUFjLEdBQUcsZUFBZSxTQUFTLE1BQU0sQ0FBQztBQUc5RixJQUFhLFlBQVksR0FBekIsTUFBYSxZQUFZO0FBQ3pCLElBSUU7QUFDRixRQUxFLGlCQUFZLEdBQUcsS0FBSyxDQUFDO0FBQ3ZCLFFBQUUsVUFBSyxHQUFpQyxFQUFFLENBQUM7QUFDM0MsUUFBRSxXQUFNLEdBQWdCLEVBQUUsQ0FBQztBQUMzQixRQUVJLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO0FBQzVCLFlBQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM5QixZQUFNLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO0FBQy9CLFNBQUs7QUFDTCxJQUFFLENBQUM7QUFDSCxJQUNFLFVBQVUsQ0FBQyxJQUEyQjtBQUN4QyxRQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUNuQyxZQUFNLE1BQU0sSUFBSSxxQkFBYSxLQUFLLENBQUUsQ0FBQztBQUNyQyxZQUFNLElBQUksQ0FBQyxJQUFJ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QUFDSCxJQUNFLGdCQUFnQixDQUNkLEtBQXlCLEVBQ3pCLElBQW9CLEVBQ3BCLEdBQWtCO0FBQ3BCLFFBQ0UsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3pELElBQUUsQ0FBQztBQUNILENBQUM7MkZBQUE7QUFDRDtBQXRLYSxZQUFZLG9CQUR4QixVQUFVLENBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLENBQUMsSUFDdEI7V0FBWSxDQXFLeEI7O2dEQUNEO0FBQUMsU0F0S1ksWUFBWTtBQUN4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtcbiAgQ29tcHJlc3NlZEVtb2ppRGF0YSxcbiAgRW1vamlEYXRhLFxuICBFbW9qaVZhcmlhdGlvbixcbn0gZnJvbSAnLi9kYXRhL2RhdGEuaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBlbW9qaXMgfSBmcm9tICcuL2RhdGEvZW1vamlzJztcbmltcG9ydCB7IEVtb2ppIH0gZnJvbSAnLi9lbW9qaS5jb21wb25lbnQnO1xuXG5jb25zdCBDT0xPTlNfUkVHRVggPSAvXig/OlxcOihbXlxcOl0rKVxcOikoPzpcXDpza2luLXRvbmUtKFxcZClcXDopPyQvO1xuY29uc3QgU0tJTlMgPSBbJzFGM0ZBJywgJzFGM0ZCJywgJzFGM0ZDJywgJzFGM0ZEJywgJzFGM0ZFJywgJzFGM0ZGJ107XG5leHBvcnQgY29uc3QgREVGQVVMVF9CQUNLR1JPVU5ERk4gPSAoXG4gIHNldDogc3RyaW5nLFxuICBzaGVldFNpemU6IG51bWJlcixcbikgPT4gYGh0dHBzOi8vdW5wa2cuY29tL2Vtb2ppLWRhdGFzb3VyY2UtJHtzZXR9QDUuMC4xL2ltZy8ke3NldH0vc2hlZXRzLTI1Ni8ke3NoZWV0U2l6ZX0ucG5nYDtcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBFbW9qaVNlcnZpY2Uge1xuICB1bmNvbXByZXNzZWQgPSBmYWxzZTtcbiAgbmFtZXM6IHsgW2tleTogc3RyaW5nXTogRW1vamlEYXRhIH0gPSB7fTtcbiAgZW1vamlzOiBFbW9qaURhdGFbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIGlmICghdGhpcy51bmNvbXByZXNzZWQpIHtcbiAgICAgIHRoaXMudW5jb21wcmVzcyhlbW9qaXMpO1xuICAgICAgdGhpcy51bmNvbXByZXNzZWQgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHVuY29tcHJlc3MobGlzdDogQ29tcHJlc3NlZEVtb2ppRGF0YVtdKSB7XG4gICAgdGhpcy5lbW9qaXMgPSBsaXN0Lm1hcChlbW9qaSA9PiB7XG4gICAgICBjb25zdCBkYXRhOiBhbnkgPSB7IC4uLmVtb2ppIH07XG4gICAgICBpZiAoIWRhdGEuc2hvcnROYW1lcykge1xuICAgICAgICBkYXRhLnNob3J0TmFtZXMgPSBbXTtcbiAgICAgIH1cbiAgICAgIGRhdGEuc2hvcnROYW1lcy51bnNoaWZ0KGRhdGEuc2hvcnROYW1lKTtcbiAgICAgIGRhdGEuaWQgPSBkYXRhLnNob3J0TmFtZTtcbiAgICAgIGRhdGEubmF0aXZlID0gdGhpcy51bmlmaWVkVG9OYXRpdmUoZGF0YS51bmlmaWVkKTtcblxuICAgICAgaWYgKCFkYXRhLnNraW5WYXJpYXRpb25zKSB7XG4gICAgICAgIGRhdGEuc2tpblZhcmlhdGlvbnMgPSBbXTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFkYXRhLmtleXdvcmRzKSB7XG4gICAgICAgIGRhdGEua2V5d29yZHMgPSBbXTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFkYXRhLmVtb3RpY29ucykge1xuICAgICAgICBkYXRhLmVtb3RpY29ucyA9IFtdO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWRhdGEuaGlkZGVuKSB7XG4gICAgICAgIGRhdGEuaGlkZGVuID0gW107XG4gICAgICB9XG5cbiAgICAgIGlmICghZGF0YS50ZXh0KSB7XG4gICAgICAgIGRhdGEudGV4dCA9ICcnO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGF0YS5vYnNvbGV0ZXMpIHtcbiAgICAgICAgLy8gZ2V0IGtleXdvcmRzIGZyb20gZW1vamkgdGhhdCBpdCBvYnNvbGV0ZXMgc2luY2UgdGhhdCBpcyBzaGFyZWRcbiAgICAgICAgY29uc3QgZiA9IGxpc3QuZmluZCh4ID0+IHgudW5pZmllZCA9PT0gZGF0YS5vYnNvbGV0ZXMpO1xuICAgICAgICBpZiAoZikge1xuICAgICAgICAgIGlmIChmLmtleXdvcmRzKSB7XG4gICAgICAgICAgICBkYXRhLmtleXdvcmRzID0gWy4uLmRhdGEua2V5d29yZHMsIC4uLmYua2V5d29yZHMsIGYuc2hvcnROYW1lXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGF0YS5rZXl3b3JkcyA9IFsuLi5kYXRhLmtleXdvcmRzLCBmLnNob3J0TmFtZV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMubmFtZXNbZGF0YS51bmlmaWVkXSA9IGRhdGE7XG4gICAgICBmb3IgKGNvbnN0IG4gb2YgZGF0YS5zaG9ydE5hbWVzKSB7XG4gICAgICAgIHRoaXMubmFtZXNbbl0gPSBkYXRhO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfSk7XG4gIH1cblxuICBnZXREYXRhKFxuICAgIGVtb2ppOiBFbW9qaURhdGEgfCBzdHJpbmcsXG4gICAgc2tpbj86IEVtb2ppWydza2luJ10sXG4gICAgc2V0PzogRW1vamlbJ3NldCddLFxuICApOiBFbW9qaURhdGEgfCBudWxsIHtcbiAgICBsZXQgZW1vamlEYXRhOiBhbnk7XG5cbiAgICBpZiAodHlwZW9mIGVtb2ppID09PSAnc3RyaW5nJykge1xuICAgICAgY29uc3QgbWF0Y2hlcyA9IGVtb2ppLm1hdGNoKENPTE9OU19SRUdFWCk7XG5cbiAgICAgIGlmIChtYXRjaGVzKSB7XG4gICAgICAgIGVtb2ppID0gbWF0Y2hlc1sxXTtcblxuICAgICAgICBpZiAobWF0Y2hlc1syXSkge1xuICAgICAgICAgIHNraW4gPSBwYXJzZUludChtYXRjaGVzWzJdLCAxMCkgYXMgRW1vamlbJ3NraW4nXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHRoaXMubmFtZXMuaGFzT3duUHJvcGVydHkoZW1vamkpKSB7XG4gICAgICAgIGVtb2ppRGF0YSA9IHRoaXMubmFtZXNbZW1vamldO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChlbW9qaS5pZCkge1xuICAgICAgZW1vamlEYXRhID0gdGhpcy5uYW1lc1tlbW9qaS5pZF07XG4gICAgfSBlbHNlIGlmIChlbW9qaS51bmlmaWVkKSB7XG4gICAgICBlbW9qaURhdGEgPSB0aGlzLm5hbWVzW2Vtb2ppLnVuaWZpZWQudG9VcHBlckNhc2UoKV07XG4gICAgfVxuXG4gICAgaWYgKCFlbW9qaURhdGEpIHtcbiAgICAgIGVtb2ppRGF0YSA9IGVtb2ppO1xuICAgICAgZW1vamlEYXRhLmN1c3RvbSA9IHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgaGFzU2tpblZhcmlhdGlvbnMgPSBlbW9qaURhdGEuc2tpblZhcmlhdGlvbnMgJiYgZW1vamlEYXRhLnNraW5WYXJpYXRpb25zLmxlbmd0aDtcbiAgICBpZiAoaGFzU2tpblZhcmlhdGlvbnMgJiYgc2tpbiAmJiBza2luID4gMSAmJiBzZXQpIHtcbiAgICAgIGVtb2ppRGF0YSA9IHsgLi4uZW1vamlEYXRhIH07XG5cbiAgICAgIGNvbnN0IHNraW5LZXkgPSBTS0lOU1tza2luIC0gMV07XG4gICAgICBjb25zdCB2YXJpYXRpb25EYXRhID0gZW1vamlEYXRhLnNraW5WYXJpYXRpb25zLmZpbmQoKG46IEVtb2ppVmFyaWF0aW9uKSA9PlxuICAgICAgICBuLnVuaWZpZWQuaW5jbHVkZXMoc2tpbktleSksXG4gICAgICApO1xuXG4gICAgICBpZiAoIXZhcmlhdGlvbkRhdGEuaGlkZGVuIHx8ICF2YXJpYXRpb25EYXRhLmhpZGRlbi5pbmNsdWRlcyhzZXQpKSB7XG4gICAgICAgIGVtb2ppRGF0YS5za2luVG9uZSA9IHNraW47XG4gICAgICAgIGVtb2ppRGF0YSA9IHsgLi4uZW1vamlEYXRhLCAuLi52YXJpYXRpb25EYXRhIH07XG4gICAgICB9XG4gICAgICBlbW9qaURhdGEubmF0aXZlID0gdGhpcy51bmlmaWVkVG9OYXRpdmUoZW1vamlEYXRhLnVuaWZpZWQpO1xuICAgIH1cblxuICAgIGVtb2ppRGF0YS5zZXQgPSBzZXQgfHwgJyc7XG4gICAgcmV0dXJuIGVtb2ppRGF0YSBhcyBFbW9qaURhdGE7XG4gIH1cblxuICB1bmlmaWVkVG9OYXRpdmUodW5pZmllZDogc3RyaW5nKSB7XG4gICAgY29uc3QgY29kZVBvaW50cyA9IHVuaWZpZWQuc3BsaXQoJy0nKS5tYXAodSA9PiBwYXJzZUludChgMHgke3V9YCwgMTYpKTtcbiAgICByZXR1cm4gU3RyaW5nLmZyb21Db2RlUG9pbnQoLi4uY29kZVBvaW50cyk7XG4gIH1cblxuICBlbW9qaVNwcml0ZVN0eWxlcyhcbiAgICBzaGVldDogRW1vamlEYXRhWydzaGVldCddLFxuICAgIHNldDogRW1vamlbJ3NldCddID0gJ2FwcGxlJyxcbiAgICBzaXplOiBFbW9qaVsnc2l6ZSddID0gMjQsXG4gICAgc2hlZXRTaXplOiBFbW9qaVsnc2hlZXRTaXplJ10gPSA2NCxcbiAgICBzaGVldFJvd3M6IEVtb2ppWydzaGVldFJvd3MnXSA9IDU3LFxuICAgIGJhY2tncm91bmRJbWFnZUZuOiBFbW9qaVsnYmFja2dyb3VuZEltYWdlRm4nXSA9IERFRkFVTFRfQkFDS0dST1VOREZOLFxuICAgIHNoZWV0Q29sdW1ucyA9IDU3LFxuICApIHtcbiAgICByZXR1cm4ge1xuICAgICAgd2lkdGg6IGAke3NpemV9cHhgLFxuICAgICAgaGVpZ2h0OiBgJHtzaXplfXB4YCxcbiAgICAgIGRpc3BsYXk6ICdpbmxpbmUtYmxvY2snLFxuICAgICAgJ2JhY2tncm91bmQtaW1hZ2UnOiBgdXJsKCR7YmFja2dyb3VuZEltYWdlRm4oc2V0LCBzaGVldFNpemUpfSlgLFxuICAgICAgJ2JhY2tncm91bmQtc2l6ZSc6IGAkezEwMCAqIHNoZWV0Q29sdW1uc30lICR7MTAwICogc2hlZXRSb3dzfSVgLFxuICAgICAgJ2JhY2tncm91bmQtcG9zaXRpb24nOiB0aGlzLmdldFNwcml0ZVBvc2l0aW9uKHNoZWV0LCBzaGVldENvbHVtbnMpLFxuICAgIH07XG4gIH1cblxuICBnZXRTcHJpdGVQb3NpdGlvbihzaGVldDogRW1vamlEYXRhWydzaGVldCddLCBzaGVldENvbHVtbnM6IG51bWJlcikge1xuICAgIGNvbnN0IFtzaGVldFgsIHNoZWV0WV0gPSBzaGVldDtcbiAgICBjb25zdCBtdWx0aXBseSA9IDEwMCAvIChzaGVldENvbHVtbnMgLSAxKTtcbiAgICByZXR1cm4gYCR7bXVsdGlwbHkgKiBzaGVldFh9JSAke211bHRpcGx5ICogc2hlZXRZfSVgO1xuICB9XG5cbiAgc2FuaXRpemUoZW1vamk6IEVtb2ppRGF0YSB8IG51bGwpOiBFbW9qaURhdGEgfCBudWxsIHtcbiAgICBpZiAoZW1vamkgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBpZCA9IGVtb2ppLmlkIHx8IGVtb2ppLnNob3J0TmFtZXNbMF07XG4gICAgbGV0IGNvbG9ucyA9IGA6JHtpZH06YDtcbiAgICBpZiAoZW1vamkuc2tpblRvbmUpIHtcbiAgICAgIGNvbG9ucyArPSBgOnNraW4tdG9uZS0ke2Vtb2ppLnNraW5Ub25lfTpgO1xuICAgIH1cbiAgICBlbW9qaS5jb2xvbnMgPSBjb2xvbnM7XG4gICAgcmV0dXJuIHsgLi4uZW1vamkgfTtcbiAgfVxuXG4gIGdldFNhbml0aXplZERhdGEoXG4gICAgZW1vamk6IHN0cmluZyB8IEVtb2ppRGF0YSxcbiAgICBza2luPzogRW1vamlbJ3NraW4nXSxcbiAgICBzZXQ/OiBFbW9qaVsnc2V0J10sXG4gICkge1xuICAgIHJldHVybiB0aGlzLnNhbml0aXplKHRoaXMuZ2V0RGF0YShlbW9qaSwgc2tpbiwgc2V0KSk7XG4gIH1cbn1cbiJdfQ==