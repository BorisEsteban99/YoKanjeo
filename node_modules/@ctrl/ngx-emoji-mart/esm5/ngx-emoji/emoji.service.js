import { __assign, __decorate, __read, __spread, __values } from "tslib";
import { Injectable } from '@angular/core';
import { emojis } from './data/emojis';
import * as i0 from "@angular/core";
import * as ɵngcc0 from '@angular/core';
var COLONS_REGEX = /^(?:\:([^\:]+)\:)(?:\:skin-tone-(\d)\:)?$/;
var SKINS = ['1F3FA', '1F3FB', '1F3FC', '1F3FD', '1F3FE', '1F3FF'];
export var DEFAULT_BACKGROUNDFN = function (set, sheetSize) { return "https://unpkg.com/emoji-datasource-" + set + "@5.0.1/img/" + set + "/sheets-256/" + sheetSize + ".png"; };
var EmojiService = /** @class */ (function () {
    function EmojiService() {
        this.uncompressed = false;
        this.names = {};
        this.emojis = [];
        if (!this.uncompressed) {
            this.uncompress(emojis);
            this.uncompressed = true;
        }
    }
    EmojiService.prototype.uncompress = function (list) {
        var _this = this;
        this.emojis = list.map(function (emoji) {
            var e_1, _a;
            var data = __assign({}, emoji);
            if (!data.shortNames) {
                data.shortNames = [];
            }
            data.shortNames.unshift(data.shortName);
            data.id = data.shortName;
            data.native = _this.unifiedToNative(data.unified);
            if (!data.skinVariations) {
                data.skinVariations = [];
            }
            if (!data.keywords) {
                data.keywords = [];
            }
            if (!data.emoticons) {
                data.emoticons = [];
            }
            if (!data.hidden) {
                data.hidden = [];
            }
            if (!data.text) {
                data.text = '';
            }
            if (data.obsoletes) {
                // get keywords from emoji that it obsoletes since that is shared
                var f = list.find(function (x) { return x.unified === data.obsoletes; });
                if (f) {
                    if (f.keywords) {
                        data.keywords = __spread(data.keywords, f.keywords, [f.shortName]);
                    }
                    else {
                        data.keywords = __spread(data.keywords, [f.shortName]);
                    }
                }
            }
            _this.names[data.unified] = data;
            try {
                for (var _b = __values(data.shortNames), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var n = _c.value;
                    _this.names[n] = data;
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
            return data;
        });
    };
    EmojiService.prototype.getData = function (emoji, skin, set) {
        var emojiData;
        if (typeof emoji === 'string') {
            var matches = emoji.match(COLONS_REGEX);
            if (matches) {
                emoji = matches[1];
                if (matches[2]) {
                    skin = parseInt(matches[2], 10);
                }
            }
            if (this.names.hasOwnProperty(emoji)) {
                emojiData = this.names[emoji];
            }
            else {
                return null;
            }
        }
        else if (emoji.id) {
            emojiData = this.names[emoji.id];
        }
        else if (emoji.unified) {
            emojiData = this.names[emoji.unified.toUpperCase()];
        }
        if (!emojiData) {
            emojiData = emoji;
            emojiData.custom = true;
        }
        var hasSkinVariations = emojiData.skinVariations && emojiData.skinVariations.length;
        if (hasSkinVariations && skin && skin > 1 && set) {
            emojiData = __assign({}, emojiData);
            var skinKey_1 = SKINS[skin - 1];
            var variationData = emojiData.skinVariations.find(function (n) {
                return n.unified.includes(skinKey_1);
            });
            if (!variationData.hidden || !variationData.hidden.includes(set)) {
                emojiData.skinTone = skin;
                emojiData = __assign(__assign({}, emojiData), variationData);
            }
            emojiData.native = this.unifiedToNative(emojiData.unified);
        }
        emojiData.set = set || '';
        return emojiData;
    };
    EmojiService.prototype.unifiedToNative = function (unified) {
        var codePoints = unified.split('-').map(function (u) { return parseInt("0x" + u, 16); });
        return String.fromCodePoint.apply(String, __spread(codePoints));
    };
    EmojiService.prototype.emojiSpriteStyles = function (sheet, set, size, sheetSize, sheetRows, backgroundImageFn, sheetColumns) {
        if (set === void 0) { set = 'apple'; }
        if (size === void 0) { size = 24; }
        if (sheetSize === void 0) { sheetSize = 64; }
        if (sheetRows === void 0) { sheetRows = 57; }
        if (backgroundImageFn === void 0) { backgroundImageFn = DEFAULT_BACKGROUNDFN; }
        if (sheetColumns === void 0) { sheetColumns = 57; }
        return {
            width: size + "px",
            height: size + "px",
            display: 'inline-block',
            'background-image': "url(" + backgroundImageFn(set, sheetSize) + ")",
            'background-size': 100 * sheetColumns + "% " + 100 * sheetRows + "%",
            'background-position': this.getSpritePosition(sheet, sheetColumns),
        };
    };
    EmojiService.prototype.getSpritePosition = function (sheet, sheetColumns) {
        var _a = __read(sheet, 2), sheetX = _a[0], sheetY = _a[1];
        var multiply = 100 / (sheetColumns - 1);
        return multiply * sheetX + "% " + multiply * sheetY + "%";
    };
    EmojiService.prototype.sanitize = function (emoji) {
        if (emoji === null) {
            return null;
        }
        var id = emoji.id || emoji.shortNames[0];
        var colons = ":" + id + ":";
        if (emoji.skinTone) {
            colons += ":skin-tone-" + emoji.skinTone + ":";
        }
        emoji.colons = colons;
        return __assign({}, emoji);
    };
    EmojiService.prototype.getSanitizedData = function (emoji, skin, set) {
        return this.sanitize(this.getData(emoji, skin, set));
    };
    EmojiService.ɵprov = i0.ɵɵdefineInjectable({ factory: function EmojiService_Factory() { return new EmojiService(); }, token: EmojiService, providedIn: "root" });
EmojiService.ɵfac = function EmojiService_Factory(t) { return new (t || EmojiService)(); };
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(EmojiService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return []; }, null); })();
    return EmojiService;
}());
export { EmojiService };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1vamkuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiQGN0cmwvbmd4LWVtb2ppLW1hcnQvbmd4LWVtb2ppL2Vtb2ppLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFPM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2Qzs7QUFFQSxJQUFNLFlBQVksR0FBRywyQ0FBMkMsQ0FBQztBQUNqRSxJQUFNLEtBQUssR0FBRyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDckUsTUFBTSxDQUFDLElBQU0sb0JBQW9CLEdBQUcsVUFDbEMsR0FBVyxFQUNYLFNBQWlCLElBQ2QsT0FBQSx3Q0FBc0MsR0FBRyxtQkFBYyxHQUFHLG9CQUFlLFNBQVMsU0FBTSxFQUF4RixDQUF3RixDQUFDO0FBRzlGO0FBQ29CLElBSWxCO0FBQ1EsUUFMUixpQkFBWSxHQUFHLEtBQUssQ0FBQztBQUN2QixRQUFFLFVBQUssR0FBaUMsRUFBRSxDQUFDO0FBQzNDLFFBQUUsV0FBTSxHQUFnQixFQUFFLENBQUM7QUFDM0IsUUFFSSxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtBQUM1QixZQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDOUIsWUFBTSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztBQUMvQixTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0gsSUFDRSxpQ0FBVSxHQUFWLFVBQVcsSUFBMkI7QUFDeEMsUUFERSxpQkFnREM7QUFDSCxRQWhESSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBQSxLQUFLO0FBQUk7QUFDYixZQUFqQixJQUFNLElBQUksZ0JBQWEsS0FBSyxDQUFFLENBQUM7QUFDckMsWUFBTSxJQUFJLENB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QVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMvQyxRQUFJLElBQUksTUFBTSxHQUFHLE1BQUksRUFBRSxNQUFHLENBQUM7QUFDM0IsUUFBSSxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUU7QUFDeEIsWUFBTSxNQUFNLElBQUksZ0JBQWMsS0FBSyxDQUFDLFFBQVEsTUFBRyxDQUFDO0FBQ2hELFNBQUs7QUFDTCxRQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0FBQzFCLFFBQUksb0JBQVksS0FBSyxFQUFHO0FBQ3hCLElBQUUsQ0FBQztBQUVILElBQUUsdUNBQWdCLEdBQWhCLFVBQ0UsS0FBeUIsRUFDekIsSUFBb0IsRUFDcEIsR0FBa0I7QUFDcEIsUUFDRSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDekQsSUFBRSxDQUFDO0FBQ0Y7SUFyS1ksWUFBWSx3QkFEeEIsVUFBVSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDLFFBQ3RCO0VBQVksQ0FxS3hCOzs7Z0RBQ0Q7QUFBQyx1QkF4TEQ7QUFBRSxDQXVMRCxBQXJLRCxJQXFLQztBQUNELFNBdEthLFlBQVk7QUFDeEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7XG4gIENvbXByZXNzZWRFbW9qaURhdGEsXG4gIEVtb2ppRGF0YSxcbiAgRW1vamlWYXJpYXRpb24sXG59IGZyb20gJy4vZGF0YS9kYXRhLmludGVyZmFjZXMnO1xuaW1wb3J0IHsgZW1vamlzIH0gZnJvbSAnLi9kYXRhL2Vtb2ppcyc7XG5pbXBvcnQgeyBFbW9qaSB9IGZyb20gJy4vZW1vamkuY29tcG9uZW50JztcblxuY29uc3QgQ09MT05TX1JFR0VYID0gL14oPzpcXDooW15cXDpdKylcXDopKD86XFw6c2tpbi10b25lLShcXGQpXFw6KT8kLztcbmNvbnN0IFNLSU5TID0gWycxRjNGQScsICcxRjNGQicsICcxRjNGQycsICcxRjNGRCcsICcxRjNGRScsICcxRjNGRiddO1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfQkFDS0dST1VOREZOID0gKFxuICBzZXQ6IHN0cmluZyxcbiAgc2hlZXRTaXplOiBudW1iZXIsXG4pID0+IGBodHRwczovL3VucGtnLmNvbS9lbW9qaS1kYXRhc291cmNlLSR7c2V0fUA1LjAuMS9pbWcvJHtzZXR9L3NoZWV0cy0yNTYvJHtzaGVldFNpemV9LnBuZ2A7XG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgRW1vamlTZXJ2aWNlIHtcbiAgdW5jb21wcmVzc2VkID0gZmFsc2U7XG4gIG5hbWVzOiB7IFtrZXk6IHN0cmluZ106IEVtb2ppRGF0YSB9ID0ge307XG4gIGVtb2ppczogRW1vamlEYXRhW10gPSBbXTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBpZiAoIXRoaXMudW5jb21wcmVzc2VkKSB7XG4gICAgICB0aGlzLnVuY29tcHJlc3MoZW1vamlzKTtcbiAgICAgIHRoaXMudW5jb21wcmVzc2VkID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICB1bmNvbXByZXNzKGxpc3Q6IENvbXByZXNzZWRFbW9qaURhdGFbXSkge1xuICAgIHRoaXMuZW1vamlzID0gbGlzdC5tYXAoZW1vamkgPT4ge1xuICAgICAgY29uc3QgZGF0YTogYW55ID0geyAuLi5lbW9qaSB9O1xuICAgICAgaWYgKCFkYXRhLnNob3J0TmFtZXMpIHtcbiAgICAgICAgZGF0YS5zaG9ydE5hbWVzID0gW107XG4gICAgICB9XG4gICAgICBkYXRhLnNob3J0TmFtZXMudW5zaGlmdChkYXRhLnNob3J0TmFtZSk7XG4gICAgICBkYXRhLmlkID0gZGF0YS5zaG9ydE5hbWU7XG4gICAgICBkYXRhLm5hdGl2ZSA9IHRoaXMudW5pZmllZFRvTmF0aXZlKGRhdGEudW5pZmllZCk7XG5cbiAgICAgIGlmICghZGF0YS5za2luVmFyaWF0aW9ucykge1xuICAgICAgICBkYXRhLnNraW5WYXJpYXRpb25zID0gW107XG4gICAgICB9XG5cbiAgICAgIGlmICghZGF0YS5rZXl3b3Jkcykge1xuICAgICAgICBkYXRhLmtleXdvcmRzID0gW107XG4gICAgICB9XG5cbiAgICAgIGlmICghZGF0YS5lbW90aWNvbnMpIHtcbiAgICAgICAgZGF0YS5lbW90aWNvbnMgPSBbXTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFkYXRhLmhpZGRlbikge1xuICAgICAgICBkYXRhLmhpZGRlbiA9IFtdO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWRhdGEudGV4dCkge1xuICAgICAgICBkYXRhLnRleHQgPSAnJztcbiAgICAgIH1cblxuICAgICAgaWYgKGRhdGEub2Jzb2xldGVzKSB7XG4gICAgICAgIC8vIGdldCBrZXl3b3JkcyBmcm9tIGVtb2ppIHRoYXQgaXQgb2Jzb2xldGVzIHNpbmNlIHRoYXQgaXMgc2hhcmVkXG4gICAgICAgIGNvbnN0IGYgPSBsaXN0LmZpbmQoeCA9PiB4LnVuaWZpZWQgPT09IGRhdGEub2Jzb2xldGVzKTtcbiAgICAgICAgaWYgKGYpIHtcbiAgICAgICAgICBpZiAoZi5rZXl3b3Jkcykge1xuICAgICAgICAgICAgZGF0YS5rZXl3b3JkcyA9IFsuLi5kYXRhLmtleXdvcmRzLCAuLi5mLmtleXdvcmRzLCBmLnNob3J0TmFtZV07XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRhdGEua2V5d29yZHMgPSBbLi4uZGF0YS5rZXl3b3JkcywgZi5zaG9ydE5hbWVdO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0aGlzLm5hbWVzW2RhdGEudW5pZmllZF0gPSBkYXRhO1xuICAgICAgZm9yIChjb25zdCBuIG9mIGRhdGEuc2hvcnROYW1lcykge1xuICAgICAgICB0aGlzLm5hbWVzW25dID0gZGF0YTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0RGF0YShcbiAgICBlbW9qaTogRW1vamlEYXRhIHwgc3RyaW5nLFxuICAgIHNraW4/OiBFbW9qaVsnc2tpbiddLFxuICAgIHNldD86IEVtb2ppWydzZXQnXSxcbiAgKTogRW1vamlEYXRhIHwgbnVsbCB7XG4gICAgbGV0IGVtb2ppRGF0YTogYW55O1xuXG4gICAgaWYgKHR5cGVvZiBlbW9qaSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnN0IG1hdGNoZXMgPSBlbW9qaS5tYXRjaChDT0xPTlNfUkVHRVgpO1xuXG4gICAgICBpZiAobWF0Y2hlcykge1xuICAgICAgICBlbW9qaSA9IG1hdGNoZXNbMV07XG5cbiAgICAgICAgaWYgKG1hdGNoZXNbMl0pIHtcbiAgICAgICAgICBza2luID0gcGFyc2VJbnQobWF0Y2hlc1syXSwgMTApIGFzIEVtb2ppWydza2luJ107XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLm5hbWVzLmhhc093blByb3BlcnR5KGVtb2ppKSkge1xuICAgICAgICBlbW9qaURhdGEgPSB0aGlzLm5hbWVzW2Vtb2ppXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZW1vamkuaWQpIHtcbiAgICAgIGVtb2ppRGF0YSA9IHRoaXMubmFtZXNbZW1vamkuaWRdO1xuICAgIH0gZWxzZSBpZiAoZW1vamkudW5pZmllZCkge1xuICAgICAgZW1vamlEYXRhID0gdGhpcy5uYW1lc1tlbW9qaS51bmlmaWVkLnRvVXBwZXJDYXNlKCldO1xuICAgIH1cblxuICAgIGlmICghZW1vamlEYXRhKSB7XG4gICAgICBlbW9qaURhdGEgPSBlbW9qaTtcbiAgICAgIGVtb2ppRGF0YS5jdXN0b20gPSB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IGhhc1NraW5WYXJpYXRpb25zID0gZW1vamlEYXRhLnNraW5WYXJpYXRpb25zICYmIGVtb2ppRGF0YS5za2luVmFyaWF0aW9ucy5sZW5ndGg7XG4gICAgaWYgKGhhc1NraW5WYXJpYXRpb25zICYmIHNraW4gJiYgc2tpbiA+IDEgJiYgc2V0KSB7XG4gICAgICBlbW9qaURhdGEgPSB7IC4uLmVtb2ppRGF0YSB9O1xuXG4gICAgICBjb25zdCBza2luS2V5ID0gU0tJTlNbc2tpbiAtIDFdO1xuICAgICAgY29uc3QgdmFyaWF0aW9uRGF0YSA9IGVtb2ppRGF0YS5za2luVmFyaWF0aW9ucy5maW5kKChuOiBFbW9qaVZhcmlhdGlvbikgPT5cbiAgICAgICAgbi51bmlmaWVkLmluY2x1ZGVzKHNraW5LZXkpLFxuICAgICAgKTtcblxuICAgICAgaWYgKCF2YXJpYXRpb25EYXRhLmhpZGRlbiB8fCAhdmFyaWF0aW9uRGF0YS5oaWRkZW4uaW5jbHVkZXMoc2V0KSkge1xuICAgICAgICBlbW9qaURhdGEuc2tpblRvbmUgPSBza2luO1xuICAgICAgICBlbW9qaURhdGEgPSB7IC4uLmVtb2ppRGF0YSwgLi4udmFyaWF0aW9uRGF0YSB9O1xuICAgICAgfVxuICAgICAgZW1vamlEYXRhLm5hdGl2ZSA9IHRoaXMudW5pZmllZFRvTmF0aXZlKGVtb2ppRGF0YS51bmlmaWVkKTtcbiAgICB9XG5cbiAgICBlbW9qaURhdGEuc2V0ID0gc2V0IHx8ICcnO1xuICAgIHJldHVybiBlbW9qaURhdGEgYXMgRW1vamlEYXRhO1xuICB9XG5cbiAgdW5pZmllZFRvTmF0aXZlKHVuaWZpZWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGNvZGVQb2ludHMgPSB1bmlmaWVkLnNwbGl0KCctJykubWFwKHUgPT4gcGFyc2VJbnQoYDB4JHt1fWAsIDE2KSk7XG4gICAgcmV0dXJuIFN0cmluZy5mcm9tQ29kZVBvaW50KC4uLmNvZGVQb2ludHMpO1xuICB9XG5cbiAgZW1vamlTcHJpdGVTdHlsZXMoXG4gICAgc2hlZXQ6IEVtb2ppRGF0YVsnc2hlZXQnXSxcbiAgICBzZXQ6IEVtb2ppWydzZXQnXSA9ICdhcHBsZScsXG4gICAgc2l6ZTogRW1vamlbJ3NpemUnXSA9IDI0LFxuICAgIHNoZWV0U2l6ZTogRW1vamlbJ3NoZWV0U2l6ZSddID0gNjQsXG4gICAgc2hlZXRSb3dzOiBFbW9qaVsnc2hlZXRSb3dzJ10gPSA1NyxcbiAgICBiYWNrZ3JvdW5kSW1hZ2VGbjogRW1vamlbJ2JhY2tncm91bmRJbWFnZUZuJ10gPSBERUZBVUxUX0JBQ0tHUk9VTkRGTixcbiAgICBzaGVldENvbHVtbnMgPSA1NyxcbiAgKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHdpZHRoOiBgJHtzaXplfXB4YCxcbiAgICAgIGhlaWdodDogYCR7c2l6ZX1weGAsXG4gICAgICBkaXNwbGF5OiAnaW5saW5lLWJsb2NrJyxcbiAgICAgICdiYWNrZ3JvdW5kLWltYWdlJzogYHVybCgke2JhY2tncm91bmRJbWFnZUZuKHNldCwgc2hlZXRTaXplKX0pYCxcbiAgICAgICdiYWNrZ3JvdW5kLXNpemUnOiBgJHsxMDAgKiBzaGVldENvbHVtbnN9JSAkezEwMCAqIHNoZWV0Um93c30lYCxcbiAgICAgICdiYWNrZ3JvdW5kLXBvc2l0aW9uJzogdGhpcy5nZXRTcHJpdGVQb3NpdGlvbihzaGVldCwgc2hlZXRDb2x1bW5zKSxcbiAgICB9O1xuICB9XG5cbiAgZ2V0U3ByaXRlUG9zaXRpb24oc2hlZXQ6IEVtb2ppRGF0YVsnc2hlZXQnXSwgc2hlZXRDb2x1bW5zOiBudW1iZXIpIHtcbiAgICBjb25zdCBbc2hlZXRYLCBzaGVldFldID0gc2hlZXQ7XG4gICAgY29uc3QgbXVsdGlwbHkgPSAxMDAgLyAoc2hlZXRDb2x1bW5zIC0gMSk7XG4gICAgcmV0dXJuIGAke211bHRpcGx5ICogc2hlZXRYfSUgJHttdWx0aXBseSAqIHNoZWV0WX0lYDtcbiAgfVxuXG4gIHNhbml0aXplKGVtb2ppOiBFbW9qaURhdGEgfCBudWxsKTogRW1vamlEYXRhIHwgbnVsbCB7XG4gICAgaWYgKGVtb2ppID09PSBudWxsKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgaWQgPSBlbW9qaS5pZCB8fCBlbW9qaS5zaG9ydE5hbWVzWzBdO1xuICAgIGxldCBjb2xvbnMgPSBgOiR7aWR9OmA7XG4gICAgaWYgKGVtb2ppLnNraW5Ub25lKSB7XG4gICAgICBjb2xvbnMgKz0gYDpza2luLXRvbmUtJHtlbW9qaS5za2luVG9uZX06YDtcbiAgICB9XG4gICAgZW1vamkuY29sb25zID0gY29sb25zO1xuICAgIHJldHVybiB7IC4uLmVtb2ppIH07XG4gIH1cblxuICBnZXRTYW5pdGl6ZWREYXRhKFxuICAgIGVtb2ppOiBzdHJpbmcgfCBFbW9qaURhdGEsXG4gICAgc2tpbj86IEVtb2ppWydza2luJ10sXG4gICAgc2V0PzogRW1vamlbJ3NldCddLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5zYW5pdGl6ZSh0aGlzLmdldERhdGEoZW1vamksIHNraW4sIHNldCkpO1xuICB9XG59XG4iXX0=