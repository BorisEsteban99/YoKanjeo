import { __decorate, __values } from "tslib";
import { Injectable } from '@angular/core';
import { categories, EmojiData, EmojiService, } from '@ctrl/ngx-emoji-mart/ngx-emoji';
import { intersect } from './utils';
import * as i0 from "@angular/core";
import * as i1 from "@ctrl/ngx-emoji-mart/ngx-emoji";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@ctrl/ngx-emoji-mart/ngx-emoji';
var EmojiSearch = /** @class */ (function () {
    function EmojiSearch(emojiService) {
        var e_1, _a;
        var _this = this;
        this.emojiService = emojiService;
        this.originalPool = {};
        this.index = {};
        this.emojisList = {};
        this.emoticonsList = {};
        this.emojiSearch = {};
        var _loop_1 = function (emojiData) {
            var shortNames = emojiData.shortNames, emoticons = emojiData.emoticons;
            var id = shortNames[0];
            emoticons.forEach(function (emoticon) {
                if (_this.emoticonsList[emoticon]) {
                    return;
                }
                _this.emoticonsList[emoticon] = id;
            });
            this_1.emojisList[id] = this_1.emojiService.getSanitizedData(id);
            this_1.originalPool[id] = emojiData;
        };
        var this_1 = this;
        try {
            for (var _b = __values(this.emojiService.emojis), _c = _b.next(); !_c.done; _c = _b.next()) {
                var emojiData = _c.value;
                _loop_1(emojiData);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
    }
    EmojiSearch.prototype.addCustomToPool = function (custom, pool) {
        var _this = this;
        custom.forEach(function (emoji) {
            var emojiId = emoji.id || emoji.shortNames[0];
            if (emojiId && !pool[emojiId]) {
                pool[emojiId] = _this.emojiService.getData(emoji);
                _this.emojisList[emojiId] = _this.emojiService.getSanitizedData(emoji);
            }
        });
    };
    EmojiSearch.prototype.search = function (value, emojisToShowFilter, maxResults, include, exclude, custom) {
        var _this = this;
        if (maxResults === void 0) { maxResults = 75; }
        if (include === void 0) { include = []; }
        if (exclude === void 0) { exclude = []; }
        if (custom === void 0) { custom = []; }
        this.addCustomToPool(custom, this.originalPool);
        var results;
        var pool = this.originalPool;
        if (value.length) {
            if (value === '-' || value === '-1') {
                return [this.emojisList['-1']];
            }
            if (value === '+' || value === '+1') {
                return [this.emojisList['+1']];
            }
            var values = value.toLowerCase().split(/[\s|,|\-|_]+/);
            var allResults = [];
            if (values.length > 2) {
                values = [values[0], values[1]];
            }
            if (include.length || exclude.length) {
                pool = {};
                categories.forEach(function (category) {
                    var isIncluded = include && include.length
                        ? include.indexOf(category.id) > -1
                        : true;
                    var isExcluded = exclude && exclude.length
                        ? exclude.indexOf(category.id) > -1
                        : false;
                    if (!isIncluded || isExcluded) {
                        return;
                    }
                    category.emojis.forEach(function (emojiId) {
                        // Need to make sure that pool gets keyed
                        // with the correct id, which is why we call emojiService.getData below
                        var emoji = _this.emojiService.getData(emojiId);
                        pool[emoji.id] = emoji;
                    });
                });
                if (custom.length) {
                    var customIsIncluded = include && include.length ? include.indexOf('custom') > -1 : true;
                    var customIsExcluded = exclude && exclude.length ? exclude.indexOf('custom') > -1 : false;
                    if (customIsIncluded && !customIsExcluded) {
                        this.addCustomToPool(custom, pool);
                    }
                }
            }
            allResults = values
                .map(function (v) {
                var aPool = pool;
                var aIndex = _this.index;
                var length = 0;
                var _loop_2 = function (charIndex) {
                    var e_2, _a;
                    var char = v[charIndex];
                    length++;
                    if (!aIndex[char]) {
                        aIndex[char] = {};
                    }
                    aIndex = aIndex[char];
                    if (!aIndex.results) {
                        var scores_1 = {};
                        aIndex.results = [];
                        aIndex.pool = {};
                        try {
                            for (var _b = (e_2 = void 0, __values(Object.keys(aPool))), _c = _b.next(); !_c.done; _c = _b.next()) {
                                var id = _c.value;
                                var emoji = aPool[id];
                                if (!_this.emojiSearch[id]) {
                                    _this.emojiSearch[id] = _this.buildSearch(emoji.short_names, emoji.name, emoji.id, emoji.keywords, emoji.emoticons);
                                }
                                var query = _this.emojiSearch[id];
                                var sub = v.substr(0, length);
                                var subIndex = query.indexOf(sub);
                                if (subIndex !== -1) {
                                    var score = subIndex + 1;
                                    if (sub === id) {
                                        score = 0;
                                    }
                                    aIndex.results.push(_this.emojisList[id]);
                                    aIndex.pool[id] = emoji;
                                    scores_1[id] = score;
                                }
                            }
                        }
                        catch (e_2_1) { e_2 = { error: e_2_1 }; }
                        finally {
                            try {
                                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                            }
                            finally { if (e_2) throw e_2.error; }
                        }
                        aIndex.results.sort(function (a, b) {
                            var aScore = scores_1[a.id];
                            var bScore = scores_1[b.id];
                            return aScore - bScore;
                        });
                    }
                    aPool = aIndex.pool;
                };
                // tslint:disable-next-line: prefer-for-of
                for (var charIndex = 0; charIndex < v.length; charIndex++) {
                    _loop_2(charIndex);
                }
                return aIndex.results;
            })
                .filter(function (a) { return a; });
            if (allResults.length > 1) {
                results = intersect.apply(null, allResults);
            }
            else if (allResults.length) {
                results = allResults[0];
            }
            else {
                results = [];
            }
        }
        if (results) {
            if (emojisToShowFilter) {
                results = results.filter(function (result) {
                    if (result && result.id) {
                        return emojisToShowFilter(_this.emojiService.names[result.id]);
                    }
                    return false;
                });
            }
            if (results && results.length > maxResults) {
                results = results.slice(0, maxResults);
            }
        }
        return results || null;
    };
    EmojiSearch.prototype.buildSearch = function (shortNames, name, id, keywords, emoticons) {
        var search = [];
        var addToSearch = function (strings, split) {
            if (!strings) {
                return;
            }
            (Array.isArray(strings) ? strings : [strings]).forEach(function (str) {
                (split ? str.split(/[-|_|\s]+/) : [str]).forEach(function (s) {
                    s = s.toLowerCase();
                    if (!search.includes(s)) {
                        search.push(s);
                    }
                });
            });
        };
        addToSearch(shortNames, true);
        addToSearch(name, true);
        addToSearch(id, true);
        addToSearch(keywords, true);
        addToSearch(emoticons, false);
        return search.join(',');
    };
    EmojiSearch.ctorParameters = function () { return [
        { type: EmojiService }
    ]; };
    EmojiSearch.ɵprov = i0.ɵɵdefineInjectable({ factory: function EmojiSearch_Factory() { return new EmojiSearch(i0.ɵɵinject(i1.EmojiService)); }, token: EmojiSearch, providedIn: "root" });
EmojiSearch.ɵfac = function EmojiSearch_Factory(t) { return new (t || EmojiSearch)(ɵngcc0.ɵɵinject(ɵngcc1.EmojiService)); };
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(EmojiSearch, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: ɵngcc1.EmojiService }]; }, null); })();
    return EmojiSearch;
}());
export { EmojiSearch };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1vamktc2VhcmNoLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIkBjdHJsL25neC1lbW9qaS1tYXJ0L2Vtb2ppLXNlYXJjaC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFDTCxVQUFVLEVBQ1YsU0FBUyxFQUNULFlBQVksR0FDYixNQUFNLGdDQUFnQyxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDcEM7QUFFQTs7O0FBQUE7QUFDb0IsSUFVbEIscUJBQW9CLFlBQTBCO0FBQ2hEO0FBQXFCLFFBRG5CLGlCQWdCQztBQUNILFFBakJzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztBQUFDLFFBVi9DLGlCQUFZLEdBQVEsRUFBRSxDQUFDO0FBQ3pCLFFBQUUsVUFBSyxHQUlELEVBQUUsQ0FBQztBQUNULFFBQUUsZUFBVSxHQUFRLEVBQUUsQ0FBQztBQUN2QixRQUFFLGtCQUFhLEdBQThCLEVBQUUsQ0FBQztBQUNoRCxRQUFFLGdCQUFXLEdBQThCLEVBQUUsQ0FBQztBQUM5QyxnQ0FFZSxTQUFTO0FBQUksWUFDZCxJQUFBLGlDQUFVLEVBQUUsK0JBQVMsQ0FBZTtBQUNsRCxZQUFNLElBQU0sRUFBRSxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMvQixZQUNNLFNBQVMsQ0FBQyxPQUFPLENBQUMsVUFBQSxRQUFRO0FBQUksZ0JBQzVCLElBQUksS0FBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRTtBQUMxQyxvQkFBVSxPQUFPO0FBQ2pCLGlCQUFTO0FBQ1QsZ0JBQ1EsS0FBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDMUMsWUFBTSxDQUFDLENBQUMsQ0FBQztBQUNULFlBQ00sT0FBSyxVQUFVLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBSyxZQUFZLENBQUMsZ0JB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QyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLENBQUM7QUFBSSxvQkFDcEQsQ0FBQyxHQUFHLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUM5QixvQkFDVSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRTtBQUNuQyx3QkFBWSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNCLHFCQUFXO0FBQ1gsZ0JBQVEsQ0FBQyxDQUFDLENBQUM7QUFDWCxZQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ1QsUUFBSSxDQUFDLENBQUM7QUFDTixRQUNJLFdBQVcsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDbEMsUUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQzVCLFFBQUksV0FBVyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUMxQixRQUFJLFdBQVcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDaEMsUUFBSSxXQUFXLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ2xDLFFBQ0ksT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzVCLElBQUUsQ0FBQztBQUNGO0FBQ3NELGdCQTFObkIsWUFBWTtBQUFHO0FBQzFDO0lBWkksV0FBVyx3QkFEdkIsVUFBVSxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDLFFBQ3RCLFdBQVcsQ0FvT3ZCOzs7OzZFQUNEO0FBQUMsc0JBL09EO0FBQUUsQ0E4T0QsQUFwT0QsSUFvT0M7QUFDRCxTQXJPYSxXQUFXO0FBQ3ZCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQge1xuICBjYXRlZ29yaWVzLFxuICBFbW9qaURhdGEsXG4gIEVtb2ppU2VydmljZSxcbn0gZnJvbSAnQGN0cmwvbmd4LWVtb2ppLW1hcnQvbmd4LWVtb2ppJztcbmltcG9ydCB7IGludGVyc2VjdCB9IGZyb20gJy4vdXRpbHMnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIEVtb2ppU2VhcmNoIHtcbiAgb3JpZ2luYWxQb29sOiBhbnkgPSB7fTtcbiAgaW5kZXg6IHtcbiAgICByZXN1bHRzPzogRW1vamlEYXRhW107XG4gICAgcG9vbD86IHsgW2tleTogc3RyaW5nXTogRW1vamlEYXRhIH07XG4gICAgW2tleTogc3RyaW5nXTogYW55O1xuICB9ID0ge307XG4gIGVtb2ppc0xpc3Q6IGFueSA9IHt9O1xuICBlbW90aWNvbnNMaXN0OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG4gIGVtb2ppU2VhcmNoOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbW9qaVNlcnZpY2U6IEVtb2ppU2VydmljZSkge1xuICAgIGZvciAoY29uc3QgZW1vamlEYXRhIG9mIHRoaXMuZW1vamlTZXJ2aWNlLmVtb2ppcykge1xuICAgICAgY29uc3QgeyBzaG9ydE5hbWVzLCBlbW90aWNvbnMgfSA9IGVtb2ppRGF0YTtcbiAgICAgIGNvbnN0IGlkID0gc2hvcnROYW1lc1swXTtcblxuICAgICAgZW1vdGljb25zLmZvckVhY2goZW1vdGljb24gPT4ge1xuICAgICAgICBpZiAodGhpcy5lbW90aWNvbnNMaXN0W2Vtb3RpY29uXSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZW1vdGljb25zTGlzdFtlbW90aWNvbl0gPSBpZDtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmVtb2ppc0xpc3RbaWRdID0gdGhpcy5lbW9qaVNlcnZpY2UuZ2V0U2FuaXRpemVkRGF0YShpZCk7XG4gICAgICB0aGlzLm9yaWdpbmFsUG9vbFtpZF0gPSBlbW9qaURhdGE7XG4gICAgfVxuICB9XG5cbiAgYWRkQ3VzdG9tVG9Qb29sKGN1c3RvbTogYW55LCBwb29sOiBhbnkpIHtcbiAgICBjdXN0b20uZm9yRWFjaCgoZW1vamk6IGFueSkgPT4ge1xuICAgICAgY29uc3QgZW1vamlJZCA9IGVtb2ppLmlkIHx8IGVtb2ppLnNob3J0TmFtZXNbMF07XG5cbiAgICAgIGlmIChlbW9qaUlkICYmICFwb29sW2Vtb2ppSWRdKSB7XG4gICAgICAgIHBvb2xbZW1vamlJZF0gPSB0aGlzLmVtb2ppU2VydmljZS5nZXREYXRhKGVtb2ppKTtcbiAgICAgICAgdGhpcy5lbW9qaXNMaXN0W2Vtb2ppSWRdID0gdGhpcy5lbW9qaVNlcnZpY2UuZ2V0U2FuaXRpemVkRGF0YShlbW9qaSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzZWFyY2goXG4gICAgdmFsdWU6IHN0cmluZyxcbiAgICBlbW9qaXNUb1Nob3dGaWx0ZXI/OiAoeDogYW55KSA9PiBib29sZWFuLFxuICAgIG1heFJlc3VsdHMgPSA3NSxcbiAgICBpbmNsdWRlOiBhbnlbXSA9IFtdLFxuICAgIGV4Y2x1ZGU6IGFueVtdID0gW10sXG4gICAgY3VzdG9tOiBhbnlbXSA9IFtdLFxuICApOiBFbW9qaURhdGFbXSB8IG51bGwge1xuICAgIHRoaXMuYWRkQ3VzdG9tVG9Qb29sKGN1c3RvbSwgdGhpcy5vcmlnaW5hbFBvb2wpO1xuXG4gICAgbGV0IHJlc3VsdHM6IEVtb2ppRGF0YVtdIHwgdW5kZWZpbmVkO1xuICAgIGxldCBwb29sID0gdGhpcy5vcmlnaW5hbFBvb2w7XG5cbiAgICBpZiAodmFsdWUubGVuZ3RoKSB7XG4gICAgICBpZiAodmFsdWUgPT09ICctJyB8fCB2YWx1ZSA9PT0gJy0xJykge1xuICAgICAgICByZXR1cm4gW3RoaXMuZW1vamlzTGlzdFsnLTEnXV07XG4gICAgICB9XG4gICAgICBpZiAodmFsdWUgPT09ICcrJyB8fCB2YWx1ZSA9PT0gJysxJykge1xuICAgICAgICByZXR1cm4gW3RoaXMuZW1vamlzTGlzdFsnKzEnXV07XG4gICAgICB9XG5cbiAgICAgIGxldCB2YWx1ZXMgPSB2YWx1ZS50b0xvd2VyQ2FzZSgpLnNwbGl0KC9bXFxzfCx8XFwtfF9dKy8pO1xuICAgICAgbGV0IGFsbFJlc3VsdHMgPSBbXTtcblxuICAgICAgaWYgKHZhbHVlcy5sZW5ndGggPiAyKSB7XG4gICAgICAgIHZhbHVlcyA9IFt2YWx1ZXNbMF0sIHZhbHVlc1sxXV07XG4gICAgICB9XG5cbiAgICAgIGlmIChpbmNsdWRlLmxlbmd0aCB8fCBleGNsdWRlLmxlbmd0aCkge1xuICAgICAgICBwb29sID0ge307XG5cbiAgICAgICAgY2F0ZWdvcmllcy5mb3JFYWNoKGNhdGVnb3J5ID0+IHtcbiAgICAgICAgICBjb25zdCBpc0luY2x1ZGVkID1cbiAgICAgICAgICAgIGluY2x1ZGUgJiYgaW5jbHVkZS5sZW5ndGhcbiAgICAgICAgICAgICAgPyBpbmNsdWRlLmluZGV4T2YoY2F0ZWdvcnkuaWQpID4gLTFcbiAgICAgICAgICAgICAgOiB0cnVlO1xuICAgICAgICAgIGNvbnN0IGlzRXhjbHVkZWQgPVxuICAgICAgICAgICAgZXhjbHVkZSAmJiBleGNsdWRlLmxlbmd0aFxuICAgICAgICAgICAgICA/IGV4Y2x1ZGUuaW5kZXhPZihjYXRlZ29yeS5pZCkgPiAtMVxuICAgICAgICAgICAgICA6IGZhbHNlO1xuICAgICAgICAgIGlmICghaXNJbmNsdWRlZCB8fCBpc0V4Y2x1ZGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY2F0ZWdvcnkuZW1vamlzLmZvckVhY2goXG4gICAgICAgICAgICBlbW9qaUlkID0+IHtcbiAgICAgICAgICAgICAgLy8gTmVlZCB0byBtYWtlIHN1cmUgdGhhdCBwb29sIGdldHMga2V5ZWRcbiAgICAgICAgICAgICAgLy8gd2l0aCB0aGUgY29ycmVjdCBpZCwgd2hpY2ggaXMgd2h5IHdlIGNhbGwgZW1vamlTZXJ2aWNlLmdldERhdGEgYmVsb3dcbiAgICAgICAgICAgICAgY29uc3QgZW1vamkgPSB0aGlzLmVtb2ppU2VydmljZS5nZXREYXRhKGVtb2ppSWQpO1xuICAgICAgICAgICAgICBwb29sW2Vtb2ppLmlkXSA9IGVtb2ppO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChjdXN0b20ubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgY3VzdG9tSXNJbmNsdWRlZCA9XG4gICAgICAgICAgICBpbmNsdWRlICYmIGluY2x1ZGUubGVuZ3RoID8gaW5jbHVkZS5pbmRleE9mKCdjdXN0b20nKSA+IC0xIDogdHJ1ZTtcbiAgICAgICAgICBjb25zdCBjdXN0b21Jc0V4Y2x1ZGVkID1cbiAgICAgICAgICAgIGV4Y2x1ZGUgJiYgZXhjbHVkZS5sZW5ndGggPyBleGNsdWRlLmluZGV4T2YoJ2N1c3RvbScpID4gLTEgOiBmYWxzZTtcbiAgICAgICAgICBpZiAoY3VzdG9tSXNJbmNsdWRlZCAmJiAhY3VzdG9tSXNFeGNsdWRlZCkge1xuICAgICAgICAgICAgdGhpcy5hZGRDdXN0b21Ub1Bvb2woY3VzdG9tLCBwb29sKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgYWxsUmVzdWx0cyA9IHZhbHVlc1xuICAgICAgICAubWFwKHYgPT4ge1xuICAgICAgICAgIGxldCBhUG9vbCA9IHBvb2w7XG4gICAgICAgICAgbGV0IGFJbmRleCA9IHRoaXMuaW5kZXg7XG4gICAgICAgICAgbGV0IGxlbmd0aCA9IDA7XG5cbiAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IHByZWZlci1mb3Itb2ZcbiAgICAgICAgICBmb3IgKGxldCBjaGFySW5kZXggPSAwOyBjaGFySW5kZXggPCB2Lmxlbmd0aDsgY2hhckluZGV4KyspIHtcbiAgICAgICAgICAgIGNvbnN0IGNoYXIgPSB2W2NoYXJJbmRleF07XG4gICAgICAgICAgICBsZW5ndGgrKztcbiAgICAgICAgICAgIGlmICghYUluZGV4W2NoYXJdKSB7XG4gICAgICAgICAgICAgIGFJbmRleFtjaGFyXSA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYUluZGV4ID0gYUluZGV4W2NoYXJdO1xuXG4gICAgICAgICAgICBpZiAoIWFJbmRleC5yZXN1bHRzKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHNjb3JlczogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfSA9IHt9O1xuXG4gICAgICAgICAgICAgIGFJbmRleC5yZXN1bHRzID0gW107XG4gICAgICAgICAgICAgIGFJbmRleC5wb29sID0ge307XG5cbiAgICAgICAgICAgICAgZm9yIChjb25zdCBpZCBvZiBPYmplY3Qua2V5cyhhUG9vbCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlbW9qaSA9IGFQb29sW2lkXTtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuZW1vamlTZWFyY2hbaWRdKSB7XG4gICAgICAgICAgICAgICAgICB0aGlzLmVtb2ppU2VhcmNoW2lkXSA9IHRoaXMuYnVpbGRTZWFyY2goXG4gICAgICAgICAgICAgICAgICAgIGVtb2ppLnNob3J0X25hbWVzLFxuICAgICAgICAgICAgICAgICAgICBlbW9qaS5uYW1lLFxuICAgICAgICAgICAgICAgICAgICBlbW9qaS5pZCxcbiAgICAgICAgICAgICAgICAgICAgZW1vamkua2V5d29yZHMsXG4gICAgICAgICAgICAgICAgICAgIGVtb2ppLmVtb3RpY29uc1xuICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgcXVlcnkgPSB0aGlzLmVtb2ppU2VhcmNoW2lkXTtcbiAgICAgICAgICAgICAgICBjb25zdCBzdWIgPSB2LnN1YnN0cigwLCBsZW5ndGgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHN1YkluZGV4ID0gcXVlcnkuaW5kZXhPZihzdWIpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHN1YkluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgbGV0IHNjb3JlID0gc3ViSW5kZXggKyAxO1xuICAgICAgICAgICAgICAgICAgaWYgKHN1YiA9PT0gaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmUgPSAwO1xuICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICBhSW5kZXgucmVzdWx0cy5wdXNoKHRoaXMuZW1vamlzTGlzdFtpZF0pO1xuICAgICAgICAgICAgICAgICAgYUluZGV4LnBvb2xbaWRdID0gZW1vamk7XG5cbiAgICAgICAgICAgICAgICAgIHNjb3Jlc1tpZF0gPSBzY29yZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBhSW5kZXgucmVzdWx0cy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgYVNjb3JlID0gc2NvcmVzW2EuaWRdO1xuICAgICAgICAgICAgICAgIGNvbnN0IGJTY29yZSA9IHNjb3Jlc1tiLmlkXTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBhU2NvcmUgLSBiU2NvcmU7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhUG9vbCA9IGFJbmRleC5wb29sO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBhSW5kZXgucmVzdWx0cztcbiAgICAgICAgfSlcbiAgICAgICAgLmZpbHRlcihhID0+IGEpO1xuXG4gICAgICBpZiAoYWxsUmVzdWx0cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIHJlc3VsdHMgPSBpbnRlcnNlY3QuYXBwbHkobnVsbCwgYWxsUmVzdWx0cyBhcyBhbnkpO1xuICAgICAgfSBlbHNlIGlmIChhbGxSZXN1bHRzLmxlbmd0aCkge1xuICAgICAgICByZXN1bHRzID0gYWxsUmVzdWx0c1swXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdHMgPSBbXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocmVzdWx0cykge1xuICAgICAgaWYgKGVtb2ppc1RvU2hvd0ZpbHRlcikge1xuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIoKHJlc3VsdDogRW1vamlEYXRhKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQuaWQpIHtcbiAgICAgICAgICAgIHJldHVybiBlbW9qaXNUb1Nob3dGaWx0ZXIodGhpcy5lbW9qaVNlcnZpY2UubmFtZXNbcmVzdWx0LmlkXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXN1bHRzICYmIHJlc3VsdHMubGVuZ3RoID4gbWF4UmVzdWx0cykge1xuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5zbGljZSgwLCBtYXhSZXN1bHRzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdHMgfHwgbnVsbDtcbiAgfVxuXG4gIGJ1aWxkU2VhcmNoKFxuICAgIHNob3J0TmFtZXM6IHN0cmluZ1tdLFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBpZDogc3RyaW5nLFxuICAgIGtleXdvcmRzOiBzdHJpbmdbXSxcbiAgICBlbW90aWNvbnM6IHN0cmluZ1tdLFxuICApIHtcbiAgICBjb25zdCBzZWFyY2g6IHN0cmluZ1tdID0gW107XG5cbiAgICBjb25zdCBhZGRUb1NlYXJjaCA9IChzdHJpbmdzOiBzdHJpbmcgfCBzdHJpbmdbXSwgc3BsaXQ6IGJvb2xlYW4pID0+IHtcbiAgICAgIGlmICghc3RyaW5ncykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIChBcnJheS5pc0FycmF5KHN0cmluZ3MpID8gc3RyaW5ncyA6IFtzdHJpbmdzXSkuZm9yRWFjaChzdHIgPT4ge1xuICAgICAgICAoc3BsaXQgPyBzdHIuc3BsaXQoL1stfF98XFxzXSsvKSA6IFtzdHJdKS5mb3JFYWNoKHMgPT4ge1xuICAgICAgICAgIHMgPSBzLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAgICAgICBpZiAoIXNlYXJjaC5pbmNsdWRlcyhzKSkge1xuICAgICAgICAgICAgc2VhcmNoLnB1c2gocyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH07XG5cbiAgICBhZGRUb1NlYXJjaChzaG9ydE5hbWVzLCB0cnVlKTtcbiAgICBhZGRUb1NlYXJjaChuYW1lLCB0cnVlKTtcbiAgICBhZGRUb1NlYXJjaChpZCwgdHJ1ZSk7XG4gICAgYWRkVG9TZWFyY2goa2V5d29yZHMsIHRydWUpO1xuICAgIGFkZFRvU2VhcmNoKGVtb3RpY29ucywgZmFsc2UpO1xuXG4gICAgcmV0dXJuIHNlYXJjaC5qb2luKCcsJyk7XG4gIH1cbn1cbiJdfQ==