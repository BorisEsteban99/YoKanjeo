import { __decorate, __metadata } from "tslib";
import { EventEmitter, Output, } from '@angular/core';
import * as ɵngcc0 from '@angular/core';
export class GoogleChartsDataTable {
    constructor(opt) {
        this.opt = opt;
        this.dataTableChanged = new EventEmitter();
        if (opt) {
            this._setDataTable(opt.dataTable, opt.firstRowIsData);
        }
    }
    send() {
        if (this.query === undefined) {
            return;
        }
        this.query.send((queryResponse) => {
            this.setDataTable(queryResponse.getDataTable());
            if (this.opt.queryCallback) {
                this.opt.queryCallback(queryResponse);
            }
        });
    }
    init(opt) {
        if (opt) {
            this.opt = opt;
        }
        if (this.tid !== undefined) {
            // doesn't work, see https://github.com/google/google-visualization-issues/issues/2381
            // this.query.abort();
            window.clearInterval(this.tid);
            this.tid = undefined;
        }
        if (this.opt.dataSourceUrl) {
            this.query = new google.visualization.Query(this.opt.dataSourceUrl);
            if (this.opt.query) {
                this.query.setQuery(this.opt.query);
            }
            if (this.opt.timeout !== undefined) {
                this.query.setTimeout(this.opt.timeout);
            }
            if (this.opt.refreshInterval) {
                // this.query.setRefreshInterval(this.opt.refreshInterval);
                this.tid = window.setInterval(() => {
                    this.send();
                }, this.opt.refreshInterval * 1000);
            }
            this.send();
        }
        else {
            this.setDataTable(this.opt.dataTable);
        }
    }
    /**
     * @returns Underlying google.visualization.DataTable
     */
    getDataTable() {
        return this.dataTable;
    }
    setDataTable(dt, firstRowIsData) {
        if (firstRowIsData === undefined) {
            firstRowIsData = this.opt.firstRowIsData;
        }
        this._setDataTable(dt, firstRowIsData);
        this.dataTableChanged.emit(this.dataTable);
    }
    _setDataTable(dt, firstRowIsData) {
        if (Array.isArray(dt)) {
            dt = google.visualization.arrayToDataTable(dt, firstRowIsData);
        }
        this.dataTable = dt;
        this.reformat();
    }
    /**
     * Applies formatters to data columns, if defined
     */
    reformat() {
        const dt = this.dataTable;
        if (dt === undefined) {
            return;
        }
        if (this.opt.formatters === undefined) {
            return;
        }
        for (const formatterConfig of this.opt.formatters) {
            let formatter;
            if (formatterConfig.type === 'PatternFormat') {
                const fmtOptions = formatterConfig.options;
                formatter = new google.visualization.PatternFormat(fmtOptions.pattern);
                formatter.format(dt, formatterConfig.columns, fmtOptions.dstColumnIndex);
                continue;
            }
            const formatterConstructor = google.visualization[formatterConfig.type];
            const formatterOptions = formatterConfig.options;
            formatter = new formatterConstructor(formatterOptions);
            if (formatterConfig.type === 'ColorFormat' && formatterOptions) {
                const fmtOptions = formatterOptions;
                for (const range of fmtOptions.ranges) {
                    if (typeof (range.fromBgColor) !== 'undefined'
                        && typeof (range.toBgColor) !== 'undefined') {
                        formatter.addGradientRange(range.from, range.to, range.color, range.fromBgColor, range.toBgColor);
                    }
                    else {
                        formatter.addRange(range.from, range.to, range.color, range.bgcolor);
                    }
                }
            }
            for (const col of formatterConfig.columns) {
                formatter.format(dt, col);
            }
        }
    }
}
GoogleChartsDataTable.ɵfac = function GoogleChartsDataTable_Factory(t) { ɵngcc0.ɵɵinvalidFactory(); };
GoogleChartsDataTable.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: GoogleChartsDataTable, outputs: { dataTableChanged: "dataTableChanged" } });
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartsDataTable.prototype, "dataTableChanged", void 0);

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWNoYXJ0cy1kYXRhdGFibGUuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25nMi1nb29nbGUtY2hhcnRzL3NyYy9saWIvZ29vZ2xlLWNoYXJ0cy1kYXRhdGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQXNGQSxPQUFPLEVBQ0wsWUFBWSxFQUNaLE1BQU0sR0FDUCxNQUFNLGVBQWUsQ0FBQzs7QUFFdkIsTUFBTSxPQUFPLHFCQUFxQjtBQUNsQyxJQU1FLFlBQW9CLEdBQW1DO0FBQ3pELFFBRHNCLFFBQUcsR0FBSCxHQUFHLENBQWdDO0FBQUMsUUFGOUMscUJBQWdCLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7QUFDckUsUUFFSSxJQUFJLEdBQUcsRUFBRTtBQUNiLFlBQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUM1RCxTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0gsSUFDVSxJQUFJO0FBQ2QsUUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO0FBQ2xDLFlBQU0sT0FBTztBQUNiLFNBQUs7QUFDTCxRQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsYUFBa0IsRUFBRSxFQUFFO0FBQzNDLFlBQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztBQUN0RCxZQUFNLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUU7QUFDbEMsZ0JBQVEsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDOUMsYUFBTztBQUNQLFFBQUksQ0FBQyxDQUFDLENBQUM7QUFDUCxJQUFFLENBQUM7QUFDSCxJQUNTLElBQUksQ0FBQyxHQUFvQztBQUNsRCxRQUFJLElBQUksR0FBRyxFQUFFO0FBQ2IsWUFBTSxJQUFJLENBQUMsR0FB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LEVBQUU7QUFDM0Qsd0JBQVksU0FBUyxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFDN0MsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMvRCxxQkFBVztBQUFDLHlCQUFLO0FBQ2pCLHdCQUFZLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ2pGLHFCQUFXO0FBQ1gsaUJBQVM7QUFDVCxhQUFPO0FBQ1AsWUFDTSxLQUFLLE1BQU0sR0FBRyxJQUFJLGVBQWUsQ0FBQyxPQUFPLEVBQUU7QUFDakQsZ0JBQVEsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDbEMsYUFBTztBQUNQLFNBQUs7QUFDTCxJQUFFLENBQUM7QUFDSDs7MElBQUM7QUF4SFc7QUFBYSxJQUF0QixNQUFNLEVBQUU7QUFBRSw4QkFBaUIsWUFBWTtBQUFFLCtEQUF5QjtBQUNyRTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiZGVjbGFyZSB2YXIgZ29vZ2xlOiBhbnk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXJyb3dGb3JtYXRJbnRlcmZhY2Uge1xuICBiYXNlOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmFyRm9ybWF0SW50ZXJmYWNlIHtcbiAgYmFzZT86IG51bWJlcjtcbiAgY29sb3JOZWdhdGl2ZT86IHN0cmluZztcbiAgY29sb3JQb3NpdGl2ZT86IHN0cmluZztcbiAgZHJhd1plcm9MaW5lPzogYm9vbGVhbjtcbiAgbWF4PzogbnVtYmVyO1xuICBtaW4/OiBudW1iZXI7XG4gIHNob3dWYWx1ZT86IGJvb2xlYW47XG4gIHdpZHRoPzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJhbmdlSW50ZXJmYWNlIHtcbiAgZnJvbTogbnVtYmVyIHwgRGF0ZSB8IG51bWJlcltdO1xuICB0bzogbnVtYmVyIHwgRGF0ZSB8IG51bWJlcltdO1xuICBjb2xvcj86IHN0cmluZztcbiAgYmdjb2xvcj86IHN0cmluZztcbiAgZnJvbUJnQ29sb3I/OiBzdHJpbmc7XG4gIHRvQmdDb2xvcj86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb2xvckZvcm1hdEludGVyZmFjZSB7XG4gIHJhbmdlcz86IFJhbmdlSW50ZXJmYWNlW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF0ZUZvcm1hdCB7XG4gIGZvcm1hdFR5cGU/OiBzdHJpbmc7XG4gIHBhdHRlcm4/OiBzdHJpbmc7XG4gIHRpbWVab25lPzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE51bWJlckZvcm1hdEludGVyZmFjZSB7XG4gIGRlY2ltYWxTeW1ib2w/OiBzdHJpbmc7XG4gIGZyYWN0aW9uRGlnaXRzPzogbnVtYmVyO1xuICBncm91cGluZ1N5bWJvbD86IHN0cmluZztcbiAgbmVnYXRpdmVDb2xvcj86IHN0cmluZztcbiAgbmVnYXRpdmVQYXJlbnM/OiBib29sZWFuO1xuICBwYXR0ZXJuPzogc3RyaW5nO1xuICBwcmVmaXg/OiBzdHJpbmc7XG4gIHN1ZmZpeD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQYXR0ZXJuRm9ybWF0SW50ZXJmYWNlIHtcbiAgcGF0dGVybjogc3RyaW5nO1xuICBkc3RDb2x1bW5JbmRleD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGb3JtYXR0ZXJJbnRlcmZhY2Uge1xuICB0eXBlOiBzdHJpbmc7XG4gIG9wdGlvbnM/OiAoXG4gICAgQXJyb3dGb3JtYXRJbnRlcmZhY2VcbiAgICB8IEJhckZvcm1hdEludGVyZmFjZVxuICAgIHwgQ29sb3JGb3JtYXRJbnRlcmZhY2VcbiAgICB8IERhdGVGb3JtYXRcbiAgICB8IE51bWJlckZvcm1hdEludGVyZmFjZVxuICAgIHwgUGF0dGVybkZvcm1hdEludGVyZmFjZVxuICApO1xuICBjb2x1bW5zOiBudW1iZXJbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHb29nbGVDaGFydHNEYXRhVGFibGVJbnRlcmZhY2Uge1xuICBkYXRhVGFibGU/OiBhbnk7XG4gIGZpcnN0Um93SXNEYXRhPzogYm9vbGVhbjtcbiAgcXVlcnk/OiBzdHJpbmc7XG4gIGRhdGFTb3VyY2VVcmw/OiBzdHJpbmc7XG5cbiAgLyoqIFJlZnJlc2ggaW50ZXJ2YWwsIGluIHNlY29uZHMsIHdoZW4gdXNpbmcgcmVtb3RlIGRhdGEgc291cmNlLiAqL1xuICByZWZyZXNoSW50ZXJ2YWw/OiBudW1iZXI7XG5cbiAgLyoqIFRpbWVvdXQgaW4gc2Vjb25kcywgd2hlbiB1c2luZyByZW1vdGUgZGF0YSBzb3VyY2UgKi9cbiAgdGltZW91dD86IG51bWJlcjtcblxuICAvKiogQ2FsbGVkIGFmdGVyIHF1ZXJ5IGV4ZWN1dGVkLiBEYXRhVGFibGUgaXMgdXBkYXRlZCBhdXRvbWF0aWNhbGx5LlxuICAgKiBAcGFyYW0gcXVlcnlSZXNwb25zZSBnb29nbGUudmlzdWFsaXphdGlvbi5RdWVyeVJlc3BvbnNlXG4gICAqL1xuICBxdWVyeUNhbGxiYWNrPzogKHF1ZXJ5UmVzcG9uc2U6IGFueSkgPT4gYW55O1xuXG4gIGZvcm1hdHRlcnM/OiBGb3JtYXR0ZXJJbnRlcmZhY2VbXTtcbiAgdmlldz86IHN0cmluZyB8IG9iamVjdCB8IG9iamVjdFtdO1xufVxuXG5pbXBvcnQge1xuICBFdmVudEVtaXR0ZXIsXG4gIE91dHB1dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmV4cG9ydCBjbGFzcyBHb29nbGVDaGFydHNEYXRhVGFibGUge1xuICBwcml2YXRlIGRhdGFUYWJsZTogYW55O1xuICBwdWJsaWMgcXVlcnk6IGFueTtcbiAgcHVibGljIHRpZDogYW55O1xuXG4gIEBPdXRwdXQoKSBkYXRhVGFibGVDaGFuZ2VkOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9wdDogR29vZ2xlQ2hhcnRzRGF0YVRhYmxlSW50ZXJmYWNlKSB7XG4gICAgaWYgKG9wdCkge1xuICAgICAgdGhpcy5fc2V0RGF0YVRhYmxlKG9wdC5kYXRhVGFibGUsIG9wdC5maXJzdFJvd0lzRGF0YSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZW5kKCkge1xuICAgIGlmICh0aGlzLnF1ZXJ5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5xdWVyeS5zZW5kKChxdWVyeVJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgIHRoaXMuc2V0RGF0YVRhYmxlKHF1ZXJ5UmVzcG9uc2UuZ2V0RGF0YVRhYmxlKCkpO1xuICAgICAgaWYgKHRoaXMub3B0LnF1ZXJ5Q2FsbGJhY2spIHtcbiAgICAgICAgdGhpcy5vcHQucXVlcnlDYWxsYmFjayhxdWVyeVJlc3BvbnNlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBpbml0KG9wdD86IEdvb2dsZUNoYXJ0c0RhdGFUYWJsZUludGVyZmFjZSkge1xuICAgIGlmIChvcHQpIHtcbiAgICAgIHRoaXMub3B0ID0gb3B0O1xuICAgIH1cblxuICAgIGlmICh0aGlzLnRpZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAvLyBkb2Vzbid0IHdvcmssIHNlZSBodHRwczovL2dpdGh1Yi5jb20vZ29vZ2xlL2dvb2dsZS12aXN1YWxpemF0aW9uLWlzc3Vlcy9pc3N1ZXMvMjM4MVxuICAgICAgLy8gdGhpcy5xdWVyeS5hYm9ydCgpO1xuICAgICAgd2luZG93LmNsZWFySW50ZXJ2YWwodGhpcy50aWQpO1xuICAgICAgdGhpcy50aWQgPSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0LmRhdGFTb3VyY2VVcmwpIHtcbiAgICAgIHRoaXMucXVlcnkgPSBuZXcgZ29vZ2xlLnZpc3VhbGl6YXRpb24uUXVlcnkodGhpcy5vcHQuZGF0YVNvdXJjZVVybCk7XG4gICAgICBpZiAodGhpcy5vcHQucXVlcnkpIHtcbiAgICAgICAgdGhpcy5xdWVyeS5zZXRRdWVyeSh0aGlzLm9wdC5xdWVyeSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5vcHQudGltZW91dCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMucXVlcnkuc2V0VGltZW91dCh0aGlzLm9wdC50aW1lb3V0KTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLm9wdC5yZWZyZXNoSW50ZXJ2YWwpIHtcbiAgICAgICAgLy8gdGhpcy5xdWVyeS5zZXRSZWZyZXNoSW50ZXJ2YWwodGhpcy5vcHQucmVmcmVzaEludGVydmFsKTtcbiAgICAgICAgdGhpcy50aWQgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc2VuZCgpO1xuICAgICAgICB9LCB0aGlzLm9wdC5yZWZyZXNoSW50ZXJ2YWwgKiAxMDAwKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2VuZCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNldERhdGFUYWJsZSh0aGlzLm9wdC5kYXRhVGFibGUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyBVbmRlcmx5aW5nIGdvb2dsZS52aXN1YWxpemF0aW9uLkRhdGFUYWJsZVxuICAgKi9cblxuICBwdWJsaWMgZ2V0RGF0YVRhYmxlKCkge1xuICAgIHJldHVybiB0aGlzLmRhdGFUYWJsZTtcbiAgfVxuXG4gIHB1YmxpYyBzZXREYXRhVGFibGUoZHQ6IGFueSwgZmlyc3RSb3dJc0RhdGE/OiBib29sZWFuKSB7XG4gICAgaWYgKGZpcnN0Um93SXNEYXRhID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGZpcnN0Um93SXNEYXRhID0gdGhpcy5vcHQuZmlyc3RSb3dJc0RhdGE7XG4gICAgfVxuICAgIHRoaXMuX3NldERhdGFUYWJsZShkdCwgZmlyc3RSb3dJc0RhdGEpO1xuICAgIHRoaXMuZGF0YVRhYmxlQ2hhbmdlZC5lbWl0KHRoaXMuZGF0YVRhYmxlKTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldERhdGFUYWJsZShkdDogYW55LCBmaXJzdFJvd0lzRGF0YT86IGJvb2xlYW4pIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShkdCkpIHtcbiAgICAgIGR0ID0gZ29vZ2xlLnZpc3VhbGl6YXRpb24uYXJyYXlUb0RhdGFUYWJsZShkdCwgZmlyc3RSb3dJc0RhdGEpO1xuICAgIH1cbiAgICB0aGlzLmRhdGFUYWJsZSA9IGR0O1xuICAgIHRoaXMucmVmb3JtYXQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBsaWVzIGZvcm1hdHRlcnMgdG8gZGF0YSBjb2x1bW5zLCBpZiBkZWZpbmVkXG4gICAqL1xuXG4gIHB1YmxpYyByZWZvcm1hdCgpIHtcbiAgICBjb25zdCBkdCA9IHRoaXMuZGF0YVRhYmxlO1xuICAgIGlmIChkdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0LmZvcm1hdHRlcnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgZm9ybWF0dGVyQ29uZmlnIG9mIHRoaXMub3B0LmZvcm1hdHRlcnMpIHtcbiAgICAgIGxldCBmb3JtYXR0ZXI6IGFueTtcbiAgICAgIGlmIChmb3JtYXR0ZXJDb25maWcudHlwZSA9PT0gJ1BhdHRlcm5Gb3JtYXQnKSB7XG4gICAgICAgIGNvbnN0IGZtdE9wdGlvbnMgPSBmb3JtYXR0ZXJDb25maWcub3B0aW9ucyBhcyBQYXR0ZXJuRm9ybWF0SW50ZXJmYWNlO1xuICAgICAgICBmb3JtYXR0ZXIgPSBuZXcgZ29vZ2xlLnZpc3VhbGl6YXRpb24uUGF0dGVybkZvcm1hdChmbXRPcHRpb25zLnBhdHRlcm4pO1xuICAgICAgICBmb3JtYXR0ZXIuZm9ybWF0KGR0LCBmb3JtYXR0ZXJDb25maWcuY29sdW1ucywgZm10T3B0aW9ucy5kc3RDb2x1bW5JbmRleCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmb3JtYXR0ZXJDb25zdHJ1Y3RvciA9IGdvb2dsZS52aXN1YWxpemF0aW9uW2Zvcm1hdHRlckNvbmZpZy50eXBlXTtcbiAgICAgIGNvbnN0IGZvcm1hdHRlck9wdGlvbnMgPSBmb3JtYXR0ZXJDb25maWcub3B0aW9ucztcbiAgICAgIGZvcm1hdHRlciA9IG5ldyBmb3JtYXR0ZXJDb25zdHJ1Y3Rvcihmb3JtYXR0ZXJPcHRpb25zKTtcbiAgICAgIGlmIChmb3JtYXR0ZXJDb25maWcudHlwZSA9PT0gJ0NvbG9yRm9ybWF0JyAmJiBmb3JtYXR0ZXJPcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IGZtdE9wdGlvbnMgPSBmb3JtYXR0ZXJPcHRpb25zIGFzIENvbG9yRm9ybWF0SW50ZXJmYWNlO1xuICAgICAgICBmb3IgKGNvbnN0IHJhbmdlIG9mIGZtdE9wdGlvbnMucmFuZ2VzKSB7XG4gICAgICAgICAgaWYgKHR5cGVvZiAocmFuZ2UuZnJvbUJnQ29sb3IpICE9PSAndW5kZWZpbmVkJ1xuICAgICAgICAgICAgICAmJiB0eXBlb2YgKHJhbmdlLnRvQmdDb2xvcikgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICBmb3JtYXR0ZXIuYWRkR3JhZGllbnRSYW5nZShyYW5nZS5mcm9tLCByYW5nZS50byxcbiAgICAgICAgICAgICAgcmFuZ2UuY29sb3IsIHJhbmdlLmZyb21CZ0NvbG9yLCByYW5nZS50b0JnQ29sb3IpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmb3JtYXR0ZXIuYWRkUmFuZ2UocmFuZ2UuZnJvbSwgcmFuZ2UudG8sIHJhbmdlLmNvbG9yLCByYW5nZS5iZ2NvbG9yKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZm9yIChjb25zdCBjb2wgb2YgZm9ybWF0dGVyQ29uZmlnLmNvbHVtbnMpIHtcbiAgICAgICAgZm9ybWF0dGVyLmZvcm1hdChkdCwgY29sKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==